<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Deploying Loki and Promtail together with the TIG stack</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=ed3448592f" />

    <link rel="canonical" href="https://nonsense.fyi/deploying-loki-and-promtail-together-with-the-tig-stack/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="https://nonsense.fyi/deploying-loki-and-promtail-together-with-the-tig-stack/amp/" />
    
    <meta property="og:site_name" content="Nonsense, for your Information" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Deploying Loki and Promtail together with the TIG stack" />
    <meta property="og:description" content="How to set up Loki, Promtail, Telegraf and Grafana to visualize logs and system stats." />
    <meta property="og:url" content="https://nonsense.fyi/deploying-loki-and-promtail-together-with-the-tig-stack/" />
    <meta property="og:image" content="https://nonsense.fyi/content/images/2020/06/Untitled-1.png" />
    <meta property="article:published_time" content="2020-06-02T02:22:12.000Z" />
    <meta property="article:modified_time" content="2020-06-02T02:28:52.000Z" />
    <meta property="article:tag" content="Automation" />
    <meta property="article:tag" content="Loki" />
    <meta property="article:tag" content="Grafana" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Deploying Loki and Promtail together with the TIG stack" />
    <meta name="twitter:description" content="How to set up Loki, Promtail, Telegraf and Grafana to visualize logs and system stats." />
    <meta name="twitter:url" content="https://nonsense.fyi/deploying-loki-and-promtail-together-with-the-tig-stack/" />
    <meta name="twitter:image" content="https://nonsense.fyi/content/images/2020/06/Untitled-1.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Simen Røstvik" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Automation, Loki, Grafana" />
    <meta name="twitter:site" content="@Roxedus" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="842" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Nonsense, for your Information",
        "url": "https://nonsense.fyi/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://nonsense.fyi/content/images/2020/04/logo-2.png"
        }
    },
    "author": {
        "@type": "Person",
        "name": "Simen Røstvik",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/db687ecb1c20468e2baf8c614cf4e711?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://nonsense.fyi/author/simen/",
        "sameAs": []
    },
    "headline": "Deploying Loki and Promtail together with the TIG stack",
    "url": "https://nonsense.fyi/deploying-loki-and-promtail-together-with-the-tig-stack/",
    "datePublished": "2020-06-02T02:22:12.000Z",
    "dateModified": "2020-06-02T02:28:52.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://nonsense.fyi/content/images/2020/06/Untitled-1.png",
        "width": 2000,
        "height": 842
    },
    "keywords": "Automation, Loki, Grafana",
    "description": "How to set up Loki, Promtail, Telegraf and Grafana to visualize logs and system stats. ",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://nonsense.fyi/"
    }
}
    </script>

    <script defer src="https://unpkg.com/@tryghost/portal@~0.14.0/umd/portal.min.js" data-ghost="https://nonsense.fyi/"></script><style> .gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style><script async src="https://js.stripe.com/v3/"></script>
    <meta name="generator" content="Ghost 3.40" />
    <link rel="alternate" type="application/rss+xml" title="Nonsense, for your Information" href="https://nonsense.fyi/rss/" />
    <!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.nonsense.fyi/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

<!-- Prism -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/themes/prism.min.css" /> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/themes/prism-tomorrow.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/plugins/toolbar/prism-toolbar.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/plugins/inline-color/prism-inline-color.min.css" />



<!-- https://github.com/lonekorean/gist-syntax-themes -->
<link rel="stylesheet" href="https://cdn.rawgit.com/lonekorean/gist-syntax-themes/b737b139/stylesheets/chaos.css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans" />

</head>
<body class="post-template tag-automation tag-loki tag-grafana">

    <div class="site-wrapper">

        

<header class="site-header">
    <div class="outer site-nav-main">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left-wrapper">
        <div class="site-nav-left">
                <a class="site-nav-logo" href="https://nonsense.fyi"><img src="/content/images/2020/04/logo-2.png" alt="Nonsense, for your Information" /></a>
            <div class="site-nav-content">
                    <ul class="nav">
    <li class="nav-home"><a href="https://nonsense.fyi/">Home</a></li>
    <li class="nav-author"><a href="https://nonsense.fyi/author/simen/">Author</a></li>
    <li class="nav-discord"><a href="https://nonsense.fyi/discord/">Discord</a></li>
</ul>

                    <span class="nav-post-title ">Deploying Loki and Promtail together with the TIG stack</span>
            </div>
        </div>
    </div>
    <div class="site-nav-right">
            <div class="social-links">
                    <a class="social-link social-link-tw" href="https://twitter.com/Roxedus" title="Twitter" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            </div>

            <a class="subscribe-button" href="#subscribe">Subscribe</a>
    </div>
</nav>
    </div>
</div></header>


<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post tag-automation tag-loki tag-grafana ">

            <header class="post-full-header">

                <section class="post-full-tags">
                    <a href="/tag/automation/">Automation</a>
                </section>

                <h1 class="post-full-title">Deploying Loki and Promtail together with the TIG stack</h1>

                <p class="post-full-custom-excerpt">How to set up Loki, Promtail, Telegraf and Grafana to visualize logs and system stats. </p>

                <div class="post-full-byline">

                    <section class="post-full-byline-content">

                        <ul class="author-list">
                            <li class="author-list-item">

                                <div class="author-card">
                                    <img class="author-profile-image" src="//www.gravatar.com/avatar/db687ecb1c20468e2baf8c614cf4e711?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x"
                                        alt="Simen Røstvik" />
                                    <div class="author-info">
                                        <h2>Simen Røstvik</h2>
                                        <p>Read <a href="/author/simen/">more posts</a> by this author.</p>
                                    </div>
                                </div>

                                <a href="/author/simen/" class="author-avatar">
                                    <img class="author-profile-image" src="//www.gravatar.com/avatar/db687ecb1c20468e2baf8c614cf4e711?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x"
                                        alt="Simen Røstvik" />
                                </a>

                            </li>
                        </ul>

                        <section class="post-full-byline-meta">
                            <h4 class="author-name"><a href="/author/simen/">Simen Røstvik</a></h4>
                            <div class="byline-meta-content">
                                <time class="byline-meta-date"
                                    datetime="2020-06-02">2 Jun 2020</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span>
                                    10 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>

            <figure class="post-full-image">
                <img srcset="/content/images/size/w300/2020/06/Untitled-1.png 300w,
                            /content/images/size/w600/2020/06/Untitled-1.png 600w,
                            /content/images/size/w1000/2020/06/Untitled-1.png 1000w,
                            /content/images/size/w2000/2020/06/Untitled-1.png 2000w" sizes="(max-width: 800px) 400px,
                        (max-width: 1170px) 1170px,
                            2000px" src="/content/images/size/w2000/2020/06/Untitled-1.png" alt="Deploying Loki and Promtail together with the TIG stack" />
            </figure>

            <section class="post-full-content">
                <div class="post-content">
                    <p>Now that I have set up this server as I want, the next step is to ensure it stays this way. One of the things I do to achieve this, is by setting up monitoring, and yes, it is very overkill for this setup. I went with a set of tools that I know, with some new additions which has been on my list of things to look into for a while, mainly <a href="https://github.com/grafana/loki/tree/master">Loki</a> and Promtail. They are both projects from <a href="https://github.com/grafana">Grafana</a> which are heavily focused on logs, both presenting them and parse them.</p><p>I'm basing this on the TIG(<a href="https://github.com/influxdata/telegraf">Telegraf</a>, <a href="https://github.com/influxdata/influxdb">InfluxDB</a>, <a href="https://github.com/grafana">Grafana</a>) stack, because I didn't want to spend time learning Prometheus, however implementing this took more time than it should've, Loki even got updated while setting it up. As I said earlier, I wanted to add some new tools in my "normal" stack. Just because Telegraf <em>can</em> do logs, does not mean it should. It can handle both syslog with a syslog-listener plugin, and docker-logs with the use of the docker socket, but Grafana has no good way of presenting them (I don't blame them). </p><hr><h1 id="setting-up-influxdb">Setting up InfluxDB</h1><p>Setting up InfluxDB in docker is quite easy. This is all it takes.</p><pre><code class="language-yaml">  influxdb:
    image: influxdb:latest
    container_name: influxdb
    environment:
      - TZ=${TZ}
    ports:
      - 127.0.0.1:8086:8086
    volumes:
      - /opt/appdata/influxdb/:/var/lib/influxdb
    restart: unless-stopped</code></pre><hr><h1 id="setting-up-telegraf">Setting up Telegraf</h1><p>Again, I choose to have a service running on the host, rather than in a container. I did this because Fail2Ban run on the host, having a container talking to a service on the host when the Telegraf plugin uses the command-line to interface with the service sounded like an unnecessary challenge.</p><p>My <code>telegraf.conf</code> is relatively small, only because I added the sections I were going to use, rather than using the one included which has all the options in it. Depending on your experience with Telegraf, it might look a bit complicated, especially the outputs. It is in fact not that advanced.</p><figure class="kg-card kg-code-card"><pre><code class="language-toml">[[outputs.influxdb]]
  database = "telegraf" # required

  retention_policy = ""
  write_consistency = "any"

  timeout = "5s"
  [outputs.influxdb.tagdrop]
    influx_database = ["docker", "nginx", "system", "web"]

[[outputs.influxdb]]
  database = "system" # required
  retention_policy = ""
  write_consistency = "any"
  timeout = "5s"
  tagexclude = ["influx_database"]
  [outputs.influxdb.tagpass]
    influx_database = ["system"]</code></pre><figcaption>telegraf.conf</figcaption></figure><p>This is mainly doing two things, to achieve the goal of diverting each type of metric into their own database in InfluxDB. Having them all in the same one isn't really a problem; it just makes it easier for <em>me</em>. To do this Telegraf has to add a tag to the metric it collects. </p><figure class="kg-card kg-code-card"><pre><code class="language-toml">[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = false
  [inputs.cpu.tags]
    influx_database = "system"</code></pre><figcaption>telegraf.conf</figcaption></figure><p>Here I tell Telegraf to <em>tag</em> all the metrics from the cpu input with the tag <code>influx_database</code> set to <code>system</code>. Telegraf can use the <code>tagpass</code> and <code>tagdrop</code> to further filter the metrics. We use <code>tagpass</code> to tell Telegraf which tags this output should allow. In the example I tell it to allow all metrics tagged with <code>influx_database</code> set to <code>system</code>. The <code>tagdrop</code> does the opposite, it tells Telegraf which tags it should <em>not</em> allow. In order to keep the output somewhat clean, I tell Telegraf to not pass the <code>influx_database</code> tag to InfluxDB. </p><p>Other than configuring nginx to show nginx_stub status on 127.0.0.1:8080, the rest of the telegraf.conf is pretty much stock.</p><pre><code class="language-nginx">server {
    listen 127.0.0.1:8080;
    location / {
        stub_status   on;
        access_log    off;
    }
}
</code></pre><hr><h1 id="setting-up-grafana">Setting up Grafana</h1><p>I noticed a while back, that you can configure Grafana purely by using <a href="https://images.roxedus.net/617d6/qEzEMopi34.gif">enviroment variables</a>, this is awesome because it can also be set up to not use the embedded sqlite database. Which means I don't need to give it a volume mount for persistent data, I did however give it a mount for using the socket instead of using http between nginx and Grafana. </p><pre><code class="language-yaml">  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    hostname: ${HOSTNAME}
    user: "1000:33"
    environment:
      - TZ=${TZ}
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_NAME=Nonsense
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_DATABASE_URL=mysql://grafana:${GrafanaDB_PASS}@mariadb/grafana
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-worldmap-panel,grafana-piechart-panel
      - GF_SECURITY_ADMIN_USER=Roxedus
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SERVER_PROTOCOL=socket
      - GF_SERVER_SOCKET=/opt/socket/grafana.socket
      # - GF_SECURITY_ADMIN_PASSWORD=${SQL_ROOT}
    volumes:
      - /opt/socket/:/opt/socket</code></pre><p>I renamed the default organization in Grafana, which means that the default anonymous(guest) access break. I fix that by declaring which organization and role the anonymous user is attached to. Then I tell Grafana how to connect to the database, and what plugins it should install on start. Since I can, I also set the admin username and password, instead of updating the user after the fact. </p><p>Unlike Ghost, Grafana doesnt have a way to set permissions on the socket. Therefore, Grafana runs as my user, as part of the www-data group. It is dirty, but it works. </p><hr><h1 id="reading-a-simple-logfile-with-promtail">Reading a simple logfile with Promtail</h1><p>The next part was getting Loki and Promtail set up. Oh boy what a task this was. I don't know why, but there isn't much content about this out there, if I were to guess people run the whole ELK stack. Which is way overkill for what I want to achieve here. The biggest hurdle personally was the fact that it was written in go, and therefore the config used some go-specific rules. Did you know that go's implementation of regex is very minimal? Or that the time-formatting is done without the notion of deliminators like YYYY-MM-DD? I for sure did not.</p><p>Getting the containers running was pretty simple, once you have downloaded the basic configuration files for <a href="https://github.com/grafana/loki/blob/v1.5.0/cmd/loki/loki-docker-config.yaml">Loki</a> and <a href="https://github.com/grafana/loki/blob/v1.5.0/cmd/promtail/promtail-docker-config.yaml">Promtail</a>. I choice to not use the default location inside the containers, I followed the practice of having all persistent data inn /config since I can override the <code>config.file</code> location with the command feature of docker. </p><pre><code class="language-yaml">  loki:
    image: grafana/loki:${LOKI_VER}
    hostname: ${HOSTNAME}
    container_name: loki
    environment:
      - TZ=${TZ}
    volumes:
      - /opt/appdata/loki/config:/config:ro
    command: -config.file=/config/loki-config.yaml

  promtail:
    image: grafana/promtail:${LOKI_VER}
    container_name: promtail
    environment:
      - TZ=${TZ}
    depends_on:
      - loki
    volumes:
      - /opt/appdata/promtail:/config:ro
      - /opt/logs:/opt/logs:ro
      - /var/log:/var/log:ro
      - /etc/machine-id:/etc/machine-id:ro
    command: -config.file=/config/promtail-config.yaml</code></pre><p>My Loki service is not too far off from the example Loki provides. I added the hostname for the machine and set the TZ. I will come back to the logging part later. </p><p>For Promtail I gave it two volume-mounts for logs, where <code>/opt/logs</code> is where the logs from the applications I run with Docker are located (not to be confused with docker logs). The next thing I did was to change the <code>promtail-config.yaml</code> file to tell Promtail to read the logs in /opt. </p><pre><code class="language-yaml">server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: system
    pipeline_stages:


    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          __path__: /var/log/**/**log
      - targets:
          - localhost
        labels:
          job: containers
          __path__: /opt/logs/**/*log</code></pre><p>I could have added the <code>__path__</code> to the varlogs job, but I added it as a new job to be able to filter it out easily in Grafana. They would present themselves something like this:</p><figure class="kg-card kg-image-card"><img src="https://nonsense.fyi/content/images/2020/05/BS3X7J3NWY.gif" class="kg-image"></figure><p>As well as labeling the data with the job-name, it also labels it with the filename, which is neat when you want to focus on a specific logfile. If you look closely you can see that Loki didn't read the timestamp properly. This is something we can fix manually and depending on the original time-format its not that difficult, after getting over the hurdles that is go's time-formatting. The documentation does cover it, but it takes a few clicks to get there, so here is a <a href="https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/timestamp.md">link</a>. There is a catch here though, especially if you know language like python. go's time-formater doesn't handle milliseconds with commas, there is an <a href="https://github.com/golang/go/issues/6189">issue</a> open about this from 2013.</p><p>You can still get the timestamp, but there is an additional step that need to be taken for that. I ran into that issue with the fail2ban logs, and I will walk you trough how I solved it. Here is a line from that log.</p><pre><code>2020-05-27 21:51:50,138 fail2ban.filter         [9474]: INFO    [sshd] Found 1.1.1.1 - 2020-05-27 21:51:50</code></pre><p>The first thing that had to be done was extracting the timestamp from the line. This is done with a <a href="https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/regex.md">regex stage</a>. Note the that the backslashes needs to be escaped.</p><pre><code class="language-yaml">- regex:
  expression: 
    "(?P&lt;time&gt;\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2},\\d{0,3}) 
    (?P&lt;message&gt;fail2ban.*(?P&lt;pid&gt;\\[\\d*\\]: )(?P&lt;level&gt;[A-Z]{4,7}) .*)"</code></pre><p>I am also going to be extracting a few other things, like the message itself, the PID and the log-level, to use in other stages. You can look at the regex in action on <a href="https://regex101.com/r/qNaeoG/">regex101.com</a>.</p><p>Now I can use the content of <code>time</code> group as a variable in Promtail. The next step is to replace the comma with a dot, so Promtail can understand the time-format. This is done with a <a href="https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/template.md">template step</a>. That is another thing worth looking into, go's template system. After reading about the replace function on the string function, it was pretty clear that it was the last piece of the puzzle I needed to solve before putting it all together. </p><pre><code class="language-yaml">- template:
  source: time
  template: '{{ Replace .Value "," "." -1 }}'</code></pre><p>Now we have the time variable available, because all the capture groups created with the regex step is exported for us to use. I pass it to the template. <code>.Value</code> is the value from the variable set as source. Then it replaces <code>,</code> with <code>.</code> for <code>-1</code> times, <code>-1</code> is the same as replace all. The output of this step is a new time variable, same name, new content. We can now define the <a href="https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/timestamp.md">timestamp </a>in the next stage. </p><pre><code class="language-yaml">- timestamp:
  source: time
  format: "2006-01-02 15:04:05.000"</code></pre><p>This is how you define a time-format in GO. This is it. It is a clever way to do it, it uses a set value for each component. The year it looks for is 2006, so it's either <code>06</code> or <code>2006</code>. The month has a few more options <code>1</code>, <code>01</code>, <code>Jan</code> or <code>January</code>. So, in a sense it is all pretty easy to read. All the possibilities for the components are in the documentation for the timestamp stage.</p><p>Now Promtail know what time the log was sent for. </p><p>I am not happy with the result; it has data I don't need, there is more I can do. If you look at the initial line from the log, it also has the time at the end, neither do I need the PID. I can fix this with another template step and a regex step. </p><pre><code class="language-yaml">- template:
  source: message
  template: '{{ Replace .Value .pid "" -1 }}'</code></pre><p>In this stage it reads the message extracted from the initial regex, then it replaces the content of the capture-group/label called <code>pid</code> with nothing.</p><pre><code class="language-yaml">- regex:
  expression: '(?P&lt;message&gt;.*)(?: - \d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})'
  source: message</code></pre><p>This regex step uses the message passed from the previous template step and creates a new message capture-group, the important thing here is that it places the eventual timestamp in its own capture group, which is not a part of the message group. </p><p>If I  were to start Promtail now, it would still see the line as it is in the log. Promtail needs to be told what it should be passing along, so we use the <a href="https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/output.md">output stage</a>.</p><pre><code class="language-yaml">- output:
   source: message</code></pre><p>However it also needs to be told what to apply all these steps to, so a final configuration to get Promtail to read and parse the Fail2Ban log would look something like this. </p><pre><code class="language-yaml">server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: system
    pipeline_stages:
      - match:
          selector: '{filename=~".*fail2ban.log"}'
          stages:
            - regex:
                expression:
                  "(?P&lt;time&gt;\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2},\\d{0,3})?\\D?
                  (?P&lt;message&gt;fail2ban.*(?P&lt;pid&gt;\\[\\d*\\]: )(?P&lt;level&gt;[A-Z]{4,7}) .*
                  (?:(?:\\[|Jail ')(?P&lt;jail&gt;\\D*)(?:\\]|'))?.*)"
            - template:
                source: message
                template: '{{ Replace .Value .pid "" -1 }}'
            - regex:
                expression: '(?P&lt;message&gt;.*)(?: - \d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})'
                source: message
            - template:
                source: time
                template: '{{ Replace .Value "," "." -1 }}'
            - timestamp:
                source: time
                format: "2006-01-02 15:04:05.000"
            - output:
                source: message


    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          __path__: /var/log/**/**log
      - targets:
          - localhost
        labels:
          job: containers
          __path__: /opt/logs/**/*log</code></pre><p>In order for Promtail to know where to apply these stages, it needs to match it to something. Grafana is then again presenting a new concept with Loki, <a href="https://github.com/grafana/loki/blob/master/docs/logql.md">LogQL</a>. It is an adaptation of Prometheus' query language, focused on logs. This is used in the selector, I kept mine simple. It is only matching against filenames ending with fail2ban.log, the filename includes paths, which is why there is a wildcard in front. </p><hr><h1 id="reading-docker-logs-with-promtail">Reading docker-logs with Promtail</h1><p>Loki has a docker log-driver, which as the time of writing has a few deal breaking issues, mainly <a href="https://github.com/grafana/loki/issues/2017">#2017</a>. To work around this, I found that sending docker-logs to the journal works for my use case. The Promtail config for this was surprisingly easy, by just setting up the journal job example from Promtails documentation.</p><pre><code class="language-yaml">server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: system
    pipeline_stages:
  - job_name: journal
    journal:
      max_age: 12h
      labels:
        job: systemd-journal
    relabel_configs:
      - source_labels: ["__journal__systemd_unit"]
        target_label: "unit"</code></pre><p>That will give us the journal from the host since <code>/var/log/journal</code> is mapped. </p><p>There is a few ways to tell docker to <a href="https://docs.docker.com/config/containers/logging/journald/">log to the journal</a>, however I am going to do it in my docker-compose. I simply just add a few lines to the containers I want to see in Grafana. </p><pre><code class="language-yaml">    logging:
      driver: journald
      options:
        mode: non-blocking</code></pre><p>My Matomo instance would then look something like this.</p><pre><code class="language-yaml">  matomo:
    image: matomo:fpm-alpine
    container_name: matomo
    logging:
      driver: journald
      options:
        mode: non-blocking
    depends_on:
      - mariadb
    volumes:
      - /opt/appdata/matomo:/var/www/html
      - /opt/logs/matomo:/logz</code></pre><p>Now I can see the logs from the Matomo container in Grafana, however it does not have a label I can use to sort out all the entries which does not come from the container. I can do that by adding a relabel action in the job-definition. Promtail presents all metadata from the journal with the <code>__journal_</code> label-prefix. This means that we can access the <code>CONTAINER_NAME</code> attribute docker adds to the logfile with the label <em><code>__journal_container_name</code></em>, so by adding a <a href="https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/configuration.md#relabel_config">relabel_config</a> we can get the container name as a label in Promtail.</p><pre><code class="language-yaml">server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: system
    pipeline_stages:
  - job_name: journal
    journal:
      max_age: 12h
      labels:
        job: systemd-journal
    relabel_configs:
      - source_labels: ["__journal__systemd_unit"]
        target_label: "unit"
      - source_labels: ["__journal_container_name"]
        target_label: "container"</code></pre><p>It will present the logs similar to this:</p><figure class="kg-card kg-image-card"><img src="https://nonsense.fyi/content/images/2020/06/5xNCB3iYhH.gif" class="kg-image"></figure><hr><h1 id="putting-it-all-together">Putting it all together</h1><p>Now that I collect all the data I want, I can start creating dashboards. </p><p>This is one I created to keep track on the frequency of fail2ban entries, with some other web-based metrics. </p><p><a href="https://stats.nonsense.fyi/d/DHlm866Wz/web-traffic-deepdive">Web Traffic DeepDive</a></p>
                </div>
            </section>

            <section class="utteranc">
    <script src="https://utteranc.es/client.js" repo="Roxedus/nonsense.fyi" issue-term="og:title" label="PostComment"
        theme="dark-blue" crossorigin="anonymous" async>
        </script>
</section>
            <section class="subscribe-form">
    <h3 class="subscribe-form-title">Subscribe to Nonsense, for your Information</h3>
    <p class="subscribe-form-description">Get the latest posts delivered right to your inbox</p>
    <form data-members-form="subscribe">
        <div class="form-group">
            <input class="subscribe-email" data-members-email placeholder="youremail@example.com" autocomplete="false" />
            <button class="button primary" type="submit">
                <span class="button-content">Subscribe</span>
                <span class="button-loader"><svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
    y="0px" width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
    <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z" />
    <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
C22.32,8.481,24.301,9.057,26.013,10.047z">
        <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 20 20" to="360 20 20"
            dur="0.5s" repeatCount="indefinite" />
    </path>
</svg></span>
            </button>
        </div>
        <div class="message-success">
            <strong>Great!</strong> Check your inbox and click the link to confirm your subscription.
        </div>
        <div class="message-error">
            Please enter a valid email address!
        </div>
    </form>
</section>

        </article>

    </div>
</main>

<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            <article class="read-next-card">
                <header class="read-next-card-header">
                    <h3><span>More in</span> <a href="/tag/automation/">Automation</a></h3>
                </header>
                <div class="read-next-card-content">
                    <ul>
                        <li>
                            <h4><a href="/gist-to-github/">Syncing gist code-snippets with a GitHub repository</a></h4>
                            <div class="read-next-card-meta">
                                <p><time datetime="2020-04-27">27 Apr 2020</time> –
                                    4 min read</p>
                            </div>
                        </li>
                    </ul>
                </div>
                <footer class="read-next-card-footer">
                    <a href="/tag/automation/">1 post
                        →</a>
                </footer>
            </article>

            <article class="post-card post tag-meta ">

    <a class="post-card-image-link" href="/utteranc-es-github-driven-comments/">
        <img class="post-card-image"
            srcset="https://images.unsplash.com/photo-1577563908411-5077b6dc7624?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ 300w,
                    https://images.unsplash.com/photo-1577563908411-5077b6dc7624?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ 600w,
                    https://images.unsplash.com/photo-1577563908411-5077b6dc7624?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ 1000w,
                    https://images.unsplash.com/photo-1577563908411-5077b6dc7624?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ 2000w"
            sizes="(max-width: 1000px) 400px, 700px"
            loading="lazy"
            src="https://images.unsplash.com/photo-1577563908411-5077b6dc7624?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ"
            alt="Utteranc.es - GitHub driven comments"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="/utteranc-es-github-driven-comments/">

            <header class="post-card-header">
                    <div class="post-card-primary-tag">About the blog itself</div>
                <h2 class="post-card-title">Utteranc.es - GitHub driven comments</h2>
            </header>

            <section class="post-card-excerpt">
                    <p>Adding GitHub driven comments to your Ghost blog</p>
            </section>

        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
            
                    <div class="author-name-tooltip">
                        Simen Røstvik
                    </div>
            
                    <a href="/author/simen/" class="static-avatar">
                        <img class="author-profile-image" src="//www.gravatar.com/avatar/db687ecb1c20468e2baf8c614cf4e711?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x" alt="Simen Røstvik" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="/author/simen/">Simen Røstvik</a></span>
                <span class="post-card-byline-date"><time datetime="2020-06-21">21 Jun 2020</time> <span class="bull">&bull;</span> 1 min read</span>
            </div>
        </footer>

    </div>

</article>

            <article class="post-card post tag-meta ">

    <a class="post-card-image-link" href="/my-discord/">
        <img class="post-card-image"
            srcset="/content/images/size/w300/2020/05/f7a4131e47f50b48b3f85f73c47ff1dc.png 300w,
                    /content/images/size/w600/2020/05/f7a4131e47f50b48b3f85f73c47ff1dc.png 600w,
                    /content/images/size/w1000/2020/05/f7a4131e47f50b48b3f85f73c47ff1dc.png 1000w,
                    /content/images/size/w2000/2020/05/f7a4131e47f50b48b3f85f73c47ff1dc.png 2000w"
            sizes="(max-width: 1000px) 400px, 700px"
            loading="lazy"
            src="/content/images/size/w600/2020/05/f7a4131e47f50b48b3f85f73c47ff1dc.png"
            alt="Talk with me!"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="/my-discord/">

            <header class="post-card-header">
                    <div class="post-card-primary-tag">About the blog itself</div>
                <h2 class="post-card-title">Talk with me!</h2>
            </header>

            <section class="post-card-excerpt">
                    <p>I have created a Discord server, due to Ghosts lack of  comment support out-of-the-box.</p>
            </section>

        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
            
                    <div class="author-name-tooltip">
                        Simen Røstvik
                    </div>
            
                    <a href="/author/simen/" class="static-avatar">
                        <img class="author-profile-image" src="//www.gravatar.com/avatar/db687ecb1c20468e2baf8c614cf4e711?s&#x3D;250&amp;d&#x3D;mm&amp;r&#x3D;x" alt="Simen Røstvik" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="/author/simen/">Simen Røstvik</a></span>
                <span class="post-card-byline-date"><time datetime="2020-05-28">28 May 2020</time> <span class="bull">&bull;</span> 1 min read</span>
            </div>
        </footer>

    </div>

</article>
        </div>
    </div>
</aside>




        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://nonsense.fyi">Nonsense, for your Information</a> &copy; 2021</section>
                <nav class="site-footer-nav">
                    <a href="https://nonsense.fyi">Latest Posts</a>
                    
                    <a href="https://twitter.com/Roxedus" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <div class="subscribe-success-message">
        <a class="subscribe-close" href="javascript:;"></a>
        You've successfully subscribed to Nonsense, for your Information!
    </div>

    <div id="subscribe" class="subscribe-overlay">
        <a class="subscribe-close-overlay" href="#"></a>
        <a class="subscribe-close-button" href="#"></a>
        <div class="subscribe-overlay-content">
                <img class="subscribe-overlay-logo" src="/content/images/2020/04/logo-2.png" alt="Nonsense, for your Information" />
            <div class="subscribe-form">
                <h1 class="subscribe-overlay-title">Subscribe to Nonsense, for your Information</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest & greatest posts delivered straight to your inbox</p>
                <form data-members-form="subscribe">
                    <div class="form-group">
                        <input class="subscribe-email" data-members-email placeholder="youremail@example.com"
                            autocomplete="false" />
                        <button class="button primary" type="submit">
                            <span class="button-content">Subscribe</span>
                            <span class="button-loader"><svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
    y="0px" width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
    <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z" />
    <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
C22.32,8.481,24.301,9.057,26.013,10.047z">
        <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 20 20" to="360 20 20"
            dur="0.5s" repeatCount="indefinite" />
    </path>
</svg></span>
                        </button>
                    </div>
                    <div class="message-success">
                        <strong>Great!</strong> Check your inbox and click the link to confirm your subscription.
                    </div>
                    <div class="message-error">
                        Please enter a valid email address!
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script
        src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous">
    </script>
    <script src="/assets/built/casper.js?v=ed3448592f"></script>

    <script>
        // Parse the URL parameter
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        // Give the parameter a variable name
        var action = getParameterByName('action');

        $(document).ready(function () {
            if (action == 'subscribe') {
                $('body').addClass("subscribe-success");
            }

            $('.subscribe-success-message .subscribe-close').click(function () {
                $('.subscribe-success-message').addClass('close');
            });

            // Reset form on opening subscrion overlay
            $('.subscribe-button').click(function() {
                $('.subscribe-overlay form').removeClass();
                $('.subscribe-email').val('');
            });
        });
    </script>

    <script>
    $(document).ready(function () {
        // FitVids - start
        var $postContent = $(".post-full-content");
        $postContent.fitVids();
        // FitVids - end

        // Replace nav with title on scroll - start
        Casper.stickyNavTitle({
            navSelector: '.site-nav-main',
            titleSelector: '.post-full-title',
            activeClass: 'nav-post-title-active'
        });
        // Replace nav with title on scroll - end

        // Hover on avatar
        var hoverTimeout;
        $('.author-list-item').hover(function () {
            var $this = $(this);

            clearTimeout(hoverTimeout);

            $('.author-card').removeClass('hovered');
            $(this).children('.author-card').addClass('hovered');

        }, function () {
            var $this = $(this);

            hoverTimeout = setTimeout(function () {
                $this.children('.author-card').removeClass('hovered');
            }, 800);
        });
    });
</script>


    <!-- Prism -->
<!--script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/prism.min.js"></script-->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/prism.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/plugins/toolbar/prism-toolbar.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/plugins/highlight-keywords/prism-highlight-keywords.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/plugins/inline-color/prism-inline-color.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-bash.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-docker.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-ini.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-json5.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-markdown.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-nginx.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-python.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-regex.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-yaml.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-toml.min.js"></script>

</body>
</html>
