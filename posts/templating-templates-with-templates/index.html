<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Templating templates with templates | nonsense.fyi</title>
<meta name=keywords content="Automation,Linuxserver.io"><meta name=description content="When you go too far with Jinja"><meta name=author content="Roxedus"><link rel=canonical href=https://nonsense.fyi/posts/templating-templates-with-templates/><link crossorigin=anonymous href=/assets/css/stylesheet.3c0edd7bac3381aa7fafecd3dd6f74529e2df70d42ea92abe524e477df9c174b.css integrity="sha256-PA7de6wzgap/r+zT3W90Up4t9w1C6pKr5STkd9+cF0s=" rel="preload stylesheet" as=style><link rel=icon href=https://nonsense.fyi/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://nonsense.fyi/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://nonsense.fyi/favicon-32x32.png><link rel=apple-touch-icon href=https://nonsense.fyi/apple-touch-icon.png><link rel=mask-icon href=https://nonsense.fyi/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async defer data-domain=nonsense.fyi src=https://hosted.roxedus.net/js/script.outbound-links.js></script><script>getCurrentVisitors().then(showCurrentVisitors),setInterval(()=>getCurrentVisitors().then(showCurrentVisitors),1e4);function showCurrentVisitors(e=0){const t=document.getElementById("current-visitors-container");if(!t)return console.info("no container to show current visitors found");t.innerHTML=`
    <a aria-hidden tabindex="-1" href="https://views.roxedus.net/nonsense.fyi" rel="nofollow noopener external" target="_blank">
        ${e}&nbsp;<svg width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 5a2 2 0 1 1-4 0 2 2 0 0 1 4 0zM8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm6 5c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/></svg>
    </a>
    `.trim()}function getCurrentVisitors(){return window.fetch("https://current-visitors.nonsense.fyi/").then(e=>e.text())}</script><meta property="og:title" content="Templating templates with templates"><meta property="og:description" content="When you go too far with Jinja"><meta property="og:type" content="article"><meta property="og:url" content="https://nonsense.fyi/posts/templating-templates-with-templates/"><meta property="og:image" content="https://nonsense.fyi/images/undraw_hacker_mind_lsio.svg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-01T00:00:00+02:00"><meta property="article:modified_time" content="2022-10-01T00:00:00+02:00"><meta property="og:site_name" content="Nonsense, For Your Information"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nonsense.fyi/images/undraw_hacker_mind_lsio.svg"><meta name=twitter:title content="Templating templates with templates"><meta name=twitter:description content="When you go too far with Jinja"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://nonsense.fyi/posts/"},{"@type":"ListItem","position":2,"name":"Templating templates with templates","item":"https://nonsense.fyi/posts/templating-templates-with-templates/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Templating templates with templates","name":"Templating templates with templates","description":"When you go too far with Jinja","keywords":["Automation","Linuxserver.io"],"articleBody":"Over at Linuxserver we use Ansible for it’s convenient integration with Jinja, a templating engine for Python, along with its powerful framework to execute shell commands. With this we are able to automate quite a lot of work, like generating a uniform and recognizable README, or injecting files into the container(don’t worry, the files are committed and pushed to GitHub before the image is built) for some logic. In order for all this to work, most of the metadata is filled into two YAML files in each repository, jenkins-vars.yml and readme-vars.yml which are then presented to Ansible as variables used for consumption in the templates.\nWhy? Having all the metadata stored in a couple of files that can be pragmatically read makes it relatively easy to expand what we are able to output, and ensuring changes propagates trough all outputs.\nAside from the Dockerfiles, the mentioned var files, and most of the root/ folder, the rest of the repository are actually templated. The benefit of this approach is huge, as we often only need to update a file once, and the changes are done in the repositories as they receive updates, like when we enabled and started promoting GHCR as the default registry for all our images, with a single pull request.\nIf you are used to the(now paid) feature of DockerHub, rebuilding images when the repository updated on GitHub, one would be accustomed to the idea of the readme on DockerHub to always reflect the readme on GitHub, however that is not the case, regardless if the repositories are linked. It is traditionally a thing you have to update by hand, however with some creative thinking you can update this with code, which we do. This means that the readme on GitHub and DockerHub is always up-to-date and identical(as long as it’s not to long for DockerHub). There’s also a derivative from the readme published to the documentation site for each image, going more in-depth for sections of the readme. To up the inception scale, we also template the CI/CD pipeline, from the small stuff like the greetings bot to the whole Jenkinsfile used to build, test and push the images.\nRemembering the once-in-a-while tasks As I touched on in the blog post announcing automated Unraid templates, creating templates for Unraid was a manual task, often depending on someone in the Linuxserver team using Unraid to actually creating one, this could mean it had the potential to take days or even weeks to push a template. As there is a decent amount of tasks tied to launching a image it might even be forgotten, so automating this step would be better for everyone involved.\nHow? As outlined earlier the important building-blocks are present, a templating engine and repository-level metadata, despite this I had to create some new blocks.\nThis adventure started with getting reacquainted to XML, as that’s how the Unraid templates are stored, remembering the specification will surely help with some future headaches.\nGetting started I start by making some helpful notes to any potential contributor wanting to help us maintaining the template, pointing them to the correct file for changing the output. As this is done in the template, the full address for the readme-vars.yml file will point to the actual repository.\n40 41 42 \u003c?xml version=\"1.0\"?\u003e Simple string substitution and conditionals Now it’s time to create the stuff that actually matters for Unraid, this is stored under the Container tag in the XML file.\n43 44 45 46 47 48 49 50 51 52 53 54 55 56 {{ param_container_name | lower }} lscr.io/{{ lsio_project_name_short }}/{{ project_name }} https://github.com/orgs/{{ lsio_project_name_short }}/packages/container/package/{{ project_name }} {{ param_net if param_usage_include_net is sameas true else 'bridge' }} {{ \"true\" if privileged is sameas true else \"false\" }} {{ project_github_repo_url }}/issues/new/choose bash {{ project_github_repo_url }}{{ \"#readme\" }} {{ project_url }} {{ ca(project_blurb) | trim }} {{ project_github_repo_url }}{{ \"#application-setup\" if app_setup_block_enabled is defined and app_setup_block_enabled }} {{ \"false\" if unraid_template_sync is sameas false else \"https://raw.githubusercontent.com/linuxserver/templates/main/unraid/\" + project_name | lower + \".xml\" }} https://raw.githubusercontent.com/linuxserver/docker-templates/master/linuxserver.io/img/linuxserver-ls-logo.png There is a few things happening here, mostly normal substituting of variables, there is also some transforming done, as \"\" is not a valid value and literal booleans needed to be it’s string counterpart, along with some logic to conditionally append a link. The rest of the template consists mostly of these types of substitutions and transformations. We will get to ca() later\nGoing in loops Unraid templates support multiple branches. When installing from a template with multiple branches defined using Community Applications, you will get prompted with a selection box with all the branches listed in the template. To populate these fields, I iterate from the same variable that lists the branches on the readme, however I have recently added some filtering here to avoid listing deprecated branches.\n59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 {# Set the Branches, if any Config items is overwritten. TODO: handle config items #} {% if development_versions is defined and development_versions == \"true\" %} {% for item in development_versions_items if not \"deprecate\" in item.desc.lower() %} {{ ca(item.tag) }} {{ ca(item.desc) }} {% if item.tag != \"latest\" %} {{ project_github_repo_url }}{{ \"/tree/\" + item.tag + \"#readme\" }} {{ project_github_repo_url }}{{ (\"/tree/\" + item.tag + \"#application-setup\") if app_setup_block_enabled is defined and app_setup_block_enabled }} {% endif %} {% if item.extra is defined %} {#- Allow for branch-specific stuff #} {{ ca(item.extra) | indent(8) | trim }} {% endif %} {% endfor %} {% endif %} {# Set the Branches, if any #} This snippet is just a simple loop going over the development_versions_items list of arrays if development_versions exists. The following readme-vars.yml produced the above screenshot:\n1 2 3 4 5 6 7 # development version development_versions: true development_versions_items: - { tag: \"latest\", desc: \"Stable Radarr releases\" } - { tag: \"develop\", desc: \"Radarr releases from their develop branch\" } - { tag: \"nightly\", desc: \"Radarr releases from their nightly branch\" } - { tag: \"nightly-alpine\", desc: \"Radarr releases from their nightly branch using our Alpine baseimage\" } I took the opportunity to add a key called extra for the dictionary, as CA has the ability to have separate config variables per branch. Unfortunately this is implemented in a way which makes it hard to use, the presence of any branch-specific items disregards all other config tags specified in the Container tag. Meaning that a dictionary like { tag: \"nightly\", desc: \"Radarr releases from their nightly branch\", extra: { nightly_var: \"Do monkeydance\"} } would render all other configuration items(such as environment variables, bind mounts and port mappings) void, if this branch was chosen. This is something I might have to account for at some time, by essentially generating the same values once per branch.\nBaby’s first macro The next part I wanted to tackle, was building the link for the WebUI, here I had to be creative, while the information needed was present, it is not easily accessible as it is stored in the format Groovy wants variables to be presented in a Jenkinsfile. The input would look like this for the SWAG image:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 repo_vars: - EXT_PIP = 'certbot' - BUILD_VERSION_ARG = 'CERTBOT_VERSION' - LS_USER = 'linuxserver' - LS_REPO = 'docker-swag' - CONTAINER_NAME = 'swag' - DOCKERHUB_IMAGE = 'linuxserver/swag' - DEV_DOCKERHUB_IMAGE = 'lsiodev/swag' - PR_DOCKERHUB_IMAGE = 'lspipepr/swag' - DIST_IMAGE = 'alpine' - MULTIARCH='true' - CI='true' - CI_WEB='false' - CI_PORT='80' - CI_SSL='false' - CI_DELAY='30' - CI_DOCKERENV='TEST_RUN=1' - CI_AUTH='' - CI_WEBPATH='' Getting the value of CI_PORT is not as easy as it should be, like using a getter on repo_vars does not work. Fortunately we can use some clever replacements and splits of each item under repo_vars to build a new and usable variable.\n1 2 3 4 5 6 {#- Create a real object from repo_vars -#} {%- set better_vars={} -%} {%- for i in repo_vars -%} {%- set i=(i | replace(' = ', '=', 1) | replace('=', '¯\\_(ツ)_/¯', 1) | replace(\"'\", \"\") | replace('\"', \"\")).split('¯\\_(ツ)_/¯') -%} {%- set x=(better_vars.__setitem__(i[0], i[1])) -%} {%- endfor -%} The new variable this creates is called better_vars, which is a dictionary-type. I and X is used as throwaway variables, as Jinja does not really have a good way to run straight up code(and with good reason, I imagine). Since repo_vars is a array-type, it serves as a iterator, and saves me from even more bodging. First order of business is to make the list uniform across both ways of placing the equals-sign, after this they don´t have any padding with spaces, I can start replacing and splitting the rest of the line until it has some resemblance of a typical python-like key-value pair.\nIn the first iteration of this code, there was no shrug, but a carefully chosen example above highlights how the split would work against us, the macro would fail when it arrived at CI_DOCKERENV, as the value of that key, is a key-value pair.\nWe are now working in Python land, so we can remove both double and single quotes, this can come back and bite us later, but as it stands right now this is not an issue. Currently CI_DOCKERENV='TEST_RUN=1' would be CI_DOCKERENV¯\\_(ツ)_/¯TEST_RUN=1, this is not useful yet, but we just need to convert this string to a key-value pair, easily done by using ¯\\_(ツ)_/¯ as the deliminator. Once we have this key-value pair we can use the __setitem__ function of the built in python dictionary-type.\nAfter all that there is now a variable that’s easier to work with, simply by using a getter.\n82 83 84 85 {# Set the WebUI link based on the link the CI runs against #} {% if better_vars.get(\"CI_WEB\") and better_vars.get(\"CI\") == \"true\" %} {{ \"https\" if better_vars.get(\"CI_SSL\") == \"true\" else \"http\" }}://[IP]:[PORT:{{ better_vars.get(\"CI_PORT\") }}] {% endif %} This value is not supposed to hold a real URL, just the parts necessary for Unraid to build one. To do this it needs to know what container port the application is running on, we do this by using the syntax [PORT:80]. Now, if a user maps the container port of 80 to say host port 180, the Unraid webui button would now point to the ip of Unraid with port 180.\nMacros save the day When we told Squid(the guy running Community Applications) to switch us over to the new repo, we actually got blacklisted in CA because I forgot how more-than and the less-than sign got treated both by xml and CA(Community Applications) specifically. In CA they are blacklisted characters, simply having them in the user-facing parts of the template gets the whole template repository blacklisted. This prompted a new macro, one to filter out the illegal characters.\n29 30 31 {%- macro ca(str) -%} {{ str | replace(\"\u003c\", \"\") | replace(\"\u003e\", \"\") | replace(\"[\", \"\") | replace(\"]\", \"\") | replace(\"\u0026\", \"and\") | escape }} {%- endmacro -%} This macro simply replaces \u003c, \u003e, [ and ] with nothing, while turning \u0026 to a word. For extra safety I put the escape filter at the end. At the time of writing there is no supported syntax in CA to make a hyperlink from a word. All “free text” input in the template goes trough this filter to prevent another blacklisting.\nGetting warm Now that I have gotten the taste, and gist of using macros, I made another couple of them to keep myself DRY(Don´t Repeat Yourself)\n32 33 34 35 36 37 38 {%- macro readme_date(str) -%} {%- set _date = (str | replace(\":\",\"\")).split(\".\") -%} {{ \"20\" + _date[2] + \"-\" + _date[1] + \"-\" + _date[0] }} {%- endmacro -%} {%- macro mask(str) -%} {{ \"true\" if [\"token\", \"pass\" ,\"key\"]|select(\"in\", str|lower) else \"false\" }} {%- endmacro -%} Since the schema made for CA supports showing a changelog, we might as well use it, the metadata needed is already present in readme-vars.yml so no real work to get the data is needed. As this is the internet, and people come from different places, the dateformat we use is of course incompatible with the one CA accept, so I made a macro to convert mm.dd.yy to yyyy.mm.dd. Next up is a macro that gets called when creating environment variables, to determine if the variable should be masked.\nAlong with a entry to list potential requirements, the changelog macro is used like this:\n89 90 91 92 93 94 95 96 97 98 99 100 101 102 {% if unraid_requirement is defined and unraid_requirement != \"\" %} {{ unraid_requirement }} {% endif %} {# Create changelog #} {% if changelogs is defined and changelogs %} {{ readme_date(changelogs |map(attribute='date') | first) }} {% for item in changelogs %} ### {{ readme_date( item.date ) }} - {{ ca(item.desc) }} {% endfor %} {% endif %} The long boi Another thing you might want to do with your container is passing along some less common parameters, like memory or cpu limits. This is something I had to tackle with ““code””. As the metadata for this is more literal to the real compose way of writing it, implementing support for security options is also coming.\n8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 {#- Create ExtraParam for REQUIRED stuff-#} {%- set ExtraParam=[] -%} {%- set x=ExtraParam.append(\"--hostname=\" + param_hostname) if param_usage_include_hostname is sameas true -%} {%- set x=ExtraParam.append(\"--mac-address=\" + param_mac_address) if param_usage_include_mac_address is sameas true -%} {%- if cap_add_param is defined -%} {%- for item in cap_add_param_vars -%} {%- set x=ExtraParam.append(\"--cap-add=\" + item.cap_add_var) -%} {%- endfor -%} {#- custom_params -#} {%- if custom_params is defined -%} {%- for item in custom_params -%} {%- if item.array is not defined -%} {%- set x=ExtraParam.append(\"--\" + item.name+ \"=\" + item.value) -%} {%- else -%} {%- for item2 in item.value -%} {%- set x=ExtraParam.append(\"--\" + item.name+ \"=\" + item2) -%} {%- endfor -%} {%- endif -%} {%- endfor -%} {%- endif -%} {%- endif -%} This logic defines a variable called ExtraParam, then massages different entries from the metadata, to a array of strings, where each item in the array is a valid docker run argument.\nThe normal stuff This article is not written in a chronological order based on the development cycle, rather following the structure in the end product. You can see this by the lack of macros in the rest of the template, if I ever have to do major revisions of this template, turning this into macros would be the first thing to do.\nPorts A good chunk of the applications we bundle, uses multiple ports for different purposes, this is why we have sections in our metadata for optional ports. Thankfully Unraid has the ability to display if a port is optional or not. The schema also exposes the protocol part of a port mapping, a value we also have support for in our metadata. Now we you can see the CA macro in action, it is used to clean characters from our metadata.\nThere is a lot of logic present to build the description and name of these ports. It will automatically name the first port as “WebUI”, or it will fall back to the naming Unraid would use. For the description it will use the one defined in the metadata, or fall back to the value Unraid would have used. Mostly the same logic is used in the optional ports.\n103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 {# Set required ports, gets the name from the name atribute if present, or \"WebUI\" if it is the first port #} {% if param_usage_include_ports | default(false) %} {% for item in param_ports %} {% set port, proto=item.internal_port.split('/') if \"/\" in item.internal_port else [item.internal_port, false] %} {#- Logic to get the protocol #} ","wordCount":"3621","inLanguage":"en","image":"https://nonsense.fyi/images/undraw_hacker_mind_lsio.svg","datePublished":"2022-10-01T00:00:00+02:00","dateModified":"2022-10-01T00:00:00+02:00","author":{"@type":"Person","name":"Roxedus"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nonsense.fyi/posts/templating-templates-with-templates/"},"publisher":{"@type":"Organization","name":"nonsense.fyi","logo":{"@type":"ImageObject","url":"https://nonsense.fyi/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://nonsense.fyi/ accesskey=h title="nonsense.fyi (Alt + H)">nonsense.fyi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://nonsense.fyi/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://nonsense.fyi/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://nonsense.fyi/>Home</a>&nbsp;»&nbsp;<a href=https://nonsense.fyi/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Templating templates with templates</h1><div class=post-description>When you go too far with Jinja</div><div class=post-meta><span title='2022-10-01 00:00:00 +0200 +0200'>October 1, 2022</span>&nbsp;·&nbsp;17 min&nbsp;·&nbsp;Roxedus</div></header><figure class=entry-cover><img loading=eager src=https://nonsense.fyi/posts/templating-templates-with-templates/images/undraw_hacker_mind_lsio.svg alt="Person walking in front of a screen"></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#why aria-label=Why?>Why?</a></li><li><a href=#remembering-the-once-in-a-while-tasks aria-label="Remembering the once-in-a-while tasks">Remembering the once-in-a-while tasks</a></li><li><a href=#how aria-label=How?>How?</a><ul><li><a href=#getting-started aria-label="Getting started">Getting started</a><ul><li><a href=#simple-string-substitution-and-conditionals aria-label="Simple string substitution and conditionals">Simple string substitution and conditionals</a></li><li><a href=#going-in-loops aria-label="Going in loops">Going in loops</a></li></ul></li><li><a href=#babys-first-macro aria-label="Baby&rsquo;s first macro">Baby&rsquo;s first macro</a><ul><li><a href=#macros-save-the-day aria-label="Macros save the day">Macros save the day</a></li><li><a href=#getting-warm aria-label="Getting warm">Getting warm</a></li></ul></li><li><a href=#the-long-boi aria-label="The long boi">The long boi</a></li><li><a href=#the-normal-stuff aria-label="The normal stuff">The normal stuff</a><ul><li><a href=#ports aria-label=Ports>Ports</a></li><li><a href=#volumes aria-label=Volumes>Volumes</a></li><li><a href=#variables aria-label=Variables>Variables</a></li><li><a href=#devices aria-label=Devices>Devices</a></li></ul></li><li><a href=#finishing-up aria-label="Finishing up">Finishing up</a></li></ul></li></ul></div></details></div><div class=post-content><p>Over at Linuxserver we use Ansible for it&rsquo;s convenient integration with Jinja, a templating engine for Python, along with its powerful framework to execute shell commands. With this we are able to automate quite a lot of work, like generating a uniform and recognizable README, or injecting files into the container(don&rsquo;t worry, the files are committed and pushed to GitHub before the image is built) for some logic. In order for all this to work, most of the metadata is filled into two YAML files in each repository, <code>jenkins-vars.yml</code> and <code>readme-vars.yml</code> which are then presented to Ansible as variables used for consumption in the templates.</p><h2 id=why>Why?<a hidden class=anchor aria-hidden=true href=#why>#</a></h2><p>Having all the metadata stored in a couple of files that can be pragmatically read makes it relatively easy to expand what we are able to output, and ensuring changes propagates trough all outputs.</p><p>Aside from the Dockerfiles, the mentioned var files, and most of the <code>root/</code> folder, the rest of the repository are actually templated. The benefit of this approach is huge, as we often only need to update a file once, and the changes are done in the repositories as they receive updates, like when we enabled and started promoting GHCR as the default registry for all our images, with a single <a href=https://github.com/linuxserver/docker-jenkins-builder/pull/69/files target=_blank rel=noopener>pull request</a>.</p><p>If you are used to the(now paid) feature of DockerHub, rebuilding images when the repository updated on GitHub, one would be accustomed to the idea of the readme on DockerHub to always reflect the readme on GitHub, however that is not the case, regardless if the repositories are linked. It is traditionally a thing you have to update by hand, however with some creative thinking you can update this with code, which we do. This means that the readme on GitHub and DockerHub is always up-to-date and identical(as long as it&rsquo;s not to long for DockerHub). There&rsquo;s also a derivative from the readme published to the <a href=https://docs.linuxserver.io target=_blank rel=noopener>documentation site</a> for each image, going more in-depth for sections of the readme. To up the inception scale, we also template the CI/CD pipeline, from the small stuff like the <a href=https://github.com/linuxserver/docker-jenkins-builder/blob/master/roles/generate-jenkins/templates/greetings.j2 target=_blank rel=noopener>greetings bot</a> to the whole <a href=https://github.com/linuxserver/docker-jenkins-builder/blob/master/roles/generate-jenkins/templates/Jenkinsfile.j2 target=_blank rel=noopener>Jenkinsfile</a> used to build, test and push the images.</p><h2 id=remembering-the-once-in-a-while-tasks>Remembering the once-in-a-while tasks<a hidden class=anchor aria-hidden=true href=#remembering-the-once-in-a-while-tasks>#</a></h2><p>As I touched on in the blog post <a href=https://www.linuxserver.io/blog/automating-the-boring-stuff-with-jinja target=_blank rel=noopener>announcing automated Unraid templates</a>, creating templates for Unraid was a manual task, often depending on someone in the Linuxserver team using Unraid to actually creating one, this could mean it had the potential to take days or even weeks to push a template. As there is a decent amount of tasks tied to launching a image it might even be forgotten, so automating this step would be better for everyone involved.</p><h2 id=how>How?<a hidden class=anchor aria-hidden=true href=#how>#</a></h2><p>As outlined earlier the important building-blocks are present, a templating engine and repository-level metadata, despite this I had to create some new blocks.</p><p>This adventure started with getting reacquainted to XML, as that&rsquo;s how the Unraid templates are stored, remembering the specification will surely help with some future headaches.</p><h3 id=getting-started>Getting started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h3><p>I start by making some helpful notes to any potential contributor wanting to help us maintaining the template, pointing them to the correct file for changing the output. As this is done in the template, the full address for the <code>readme-vars.yml</code> file will point to the actual repository.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- DO NOT CHANGE THIS FILE MANUALLY, IT IS AUTOMATICALLY GENERATED --&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- GENERATED FROM {{ project_github_asset }}/readme-vars.yml --&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=simple-string-substitution-and-conditionals>Simple string substitution and conditionals<a hidden class=anchor aria-hidden=true href=#simple-string-substitution-and-conditionals>#</a></h4><p>Now it&rsquo;s time to create the stuff that actually matters for Unraid, this is stored under the <code>Container</code> tag in the XML file.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=x>&lt;Container version=&#34;2&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;Name&gt;</span><span class=cp>{{</span> <span class=nv>param_container_name</span> <span class=o>|</span> <span class=nf>lower</span> <span class=cp>}}</span><span class=x>&lt;/Name&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;Repository&gt;lscr.io/</span><span class=cp>{{</span> <span class=nv>lsio_project_name_short</span> <span class=cp>}}</span><span class=x>/</span><span class=cp>{{</span> <span class=nv>project_name</span> <span class=cp>}}</span><span class=x>&lt;/Repository&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;Registry&gt;https://github.com/orgs/</span><span class=cp>{{</span> <span class=nv>lsio_project_name_short</span> <span class=cp>}}</span><span class=x>/packages/container/package/</span><span class=cp>{{</span> <span class=nv>project_name</span> <span class=cp>}}</span><span class=x>&lt;/Registry&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;Network&gt;</span><span class=cp>{{</span> <span class=nv>param_net</span> <span class=k>if</span> <span class=nv>param_usage_include_net</span> <span class=k>is</span> <span class=nf>sameas</span> <span class=kp>true</span> <span class=k>else</span> <span class=s1>&#39;bridge&#39;</span> <span class=cp>}}</span><span class=x>&lt;/Network&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;Privileged&gt;</span><span class=cp>{{</span> <span class=s2>&#34;true&#34;</span> <span class=k>if</span> <span class=nv>privileged</span> <span class=k>is</span> <span class=nf>sameas</span> <span class=kp>true</span> <span class=k>else</span> <span class=s2>&#34;false&#34;</span> <span class=cp>}}</span><span class=x>&lt;/Privileged&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;Support&gt;</span><span class=cp>{{</span> <span class=nv>project_github_repo_url</span> <span class=cp>}}</span><span class=x>/issues/new/choose&lt;/Support&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;Shell&gt;bash&lt;/Shell&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;ReadMe&gt;</span><span class=cp>{{</span> <span class=nv>project_github_repo_url</span> <span class=cp>}}{{</span> <span class=s2>&#34;#readme&#34;</span> <span class=cp>}}</span><span class=x>&lt;/ReadMe&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;Project&gt;</span><span class=cp>{{</span> <span class=nv>project_url</span> <span class=cp>}}</span><span class=x>&lt;/Project&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;Overview&gt;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>project_blurb</span><span class=o>)</span> <span class=o>|</span> <span class=nf>trim</span> <span class=cp>}}</span><span class=x>&lt;/Overview&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;GitHub&gt;</span><span class=cp>{{</span> <span class=nv>project_github_repo_url</span> <span class=cp>}}{{</span> <span class=s2>&#34;#application-setup&#34;</span> <span class=k>if</span> <span class=nv>app_setup_block_enabled</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>and</span> <span class=nv>app_setup_block_enabled</span> <span class=cp>}}</span><span class=x>&lt;/GitHub&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;TemplateURL&gt;</span><span class=cp>{{</span> <span class=s2>&#34;false&#34;</span> <span class=k>if</span> <span class=nv>unraid_template_sync</span> <span class=k>is</span> <span class=nf>sameas</span> <span class=kp>false</span> <span class=k>else</span> <span class=s2>&#34;https://raw.githubusercontent.com/linuxserver/templates/main/unraid/&#34;</span> <span class=o>+</span> <span class=nv>project_name</span> <span class=o>|</span> <span class=nf>lower</span> <span class=o>+</span> <span class=s2>&#34;.xml&#34;</span> <span class=cp>}}</span><span class=x>&lt;/TemplateURL&gt;
</span></span></span><span class=line><span class=cl><span class=x>  &lt;Icon&gt;https://raw.githubusercontent.com/linuxserver/docker-templates/master/linuxserver.io/img/linuxserver-ls-logo.png&lt;/Icon&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>There is a few things happening here, mostly normal substituting of variables, there is also some transforming done, as <code>""</code> is not a valid value and literal booleans needed to be it&rsquo;s string counterpart, along with some logic to conditionally append a link. The rest of the template consists mostly of these types of substitutions and transformations. We will get to <code>ca()</code> <a href=#macros-save-the-day>later</a></p><h4 id=going-in-loops>Going in loops<a hidden class=anchor aria-hidden=true href=#going-in-loops>#</a></h4><p>Unraid templates support multiple branches. When installing from a template with multiple branches defined using Community Applications, you will get prompted with a selection box with all the branches listed in the template.<figure class=align-center><img loading=lazy src=images/BranchPicker.png#center alt="Image of Unraids Branch picker"></figure>To populate these fields, I iterate from the same variable that lists the branches on the readme, however I have recently added some filtering here to avoid listing deprecated branches.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=c>{# Set the Branches, if any Config items is overwritten. TODO: handle config items #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>development_versions</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>and</span> <span class=nv>development_versions</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>development_versions_items</span> <span class=k>if</span> <span class=k>not</span> <span class=s2>&#34;deprecate&#34;</span> <span class=k>in</span> <span class=nv>item.desc.lower</span><span class=o>()</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Branch&gt;
</span></span></span><span class=line><span class=cl><span class=x>        &lt;Tag&gt;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.tag</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&lt;/Tag&gt;
</span></span></span><span class=line><span class=cl><span class=x>        &lt;TagDescription&gt;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.desc</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&lt;/TagDescription&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>item.tag</span> <span class=p>!</span><span class=o>=</span> <span class=s2>&#34;latest&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>        &lt;ReadMe&gt;</span><span class=cp>{{</span> <span class=nv>project_github_repo_url</span> <span class=cp>}}{{</span> <span class=s2>&#34;/tree/&#34;</span> <span class=o>+</span> <span class=nv>item.tag</span> <span class=o>+</span> <span class=s2>&#34;#readme&#34;</span> <span class=cp>}}</span><span class=x>&lt;/ReadMe&gt;
</span></span></span><span class=line><span class=cl><span class=x>        &lt;GitHub&gt;</span><span class=cp>{{</span> <span class=nv>project_github_repo_url</span> <span class=cp>}}{{</span> <span class=o>(</span><span class=s2>&#34;/tree/&#34;</span> <span class=o>+</span> <span class=nv>item.tag</span> <span class=o>+</span> <span class=s2>&#34;#application-setup&#34;</span><span class=o>)</span> <span class=k>if</span> <span class=nv>app_setup_block_enabled</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>and</span> <span class=nv>app_setup_block_enabled</span> <span class=cp>}}</span><span class=x>&lt;/GitHub&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>item.extra</span> <span class=k>is</span> <span class=nf>defined</span> <span class=cp>%}</span><span class=x> </span><span class=c>{#- Allow for branch-specific stuff #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>        </span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.extra</span><span class=o>)</span> <span class=o>|</span> <span class=nf>indent</span><span class=o>(</span><span class=m>8</span><span class=o>)</span> <span class=o>|</span> <span class=nf>trim</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;/Branch&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{# Set the Branches, if any #}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div><p>This snippet is just a simple loop going over the <code>development_versions_items</code> list of arrays if <code>development_versions</code> exists. The following <code>readme-vars.yml</code> produced the above screenshot:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># development version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>development_versions</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>development_versions_items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- {<span class=w> </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;latest&#34;</span><span class=nt>, desc</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Stable Radarr releases&#34;</span><span class=w> </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- {<span class=w> </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;develop&#34;</span><span class=nt>, desc</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Radarr releases from their develop branch&#34;</span><span class=w> </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- {<span class=w> </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;nightly&#34;</span><span class=nt>, desc</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Radarr releases from their nightly branch&#34;</span><span class=w> </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- {<span class=w> </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;nightly-alpine&#34;</span><span class=nt>, desc</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Radarr releases from their nightly branch using our Alpine baseimage&#34;</span><span class=w> </span>}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>I took the opportunity to add a key called <code>extra</code> for the dictionary, as CA has the ability to have separate config variables per branch. Unfortunately this is implemented in a way which makes it hard to use, the presence of any branch-specific items disregards all other config tags specified in the <code>Container</code> tag. Meaning that a dictionary like <code>{ tag: "nightly", desc: "Radarr releases from their nightly branch", extra: { nightly_var: "Do monkeydance"} }</code> would render all other configuration items(such as environment variables, bind mounts and port mappings) void, if this branch was chosen. This is something I might have to account for at some time, by essentially generating the same values once per branch.</p><h3 id=babys-first-macro>Baby&rsquo;s first macro<a hidden class=anchor aria-hidden=true href=#babys-first-macro>#</a></h3><p>The next part I wanted to tackle, was building the link for the WebUI, here I had to be creative, while the information needed was present, it is not easily accessible as it is stored in the format Groovy wants variables to be presented in a Jenkinsfile. The input would look like this for the SWAG image:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>repo_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>EXT_PIP = &#39;certbot&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>BUILD_VERSION_ARG = &#39;CERTBOT_VERSION&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>LS_USER = &#39;linuxserver&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>LS_REPO = &#39;docker-swag&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>CONTAINER_NAME = &#39;swag&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOCKERHUB_IMAGE = &#39;linuxserver/swag&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DEV_DOCKERHUB_IMAGE = &#39;lsiodev/swag&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>PR_DOCKERHUB_IMAGE = &#39;lspipepr/swag&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DIST_IMAGE = &#39;alpine&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>MULTIARCH=&#39;true&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>CI=&#39;true&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>CI_WEB=&#39;false&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>CI_PORT=&#39;80&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>CI_SSL=&#39;false&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>CI_DELAY=&#39;30&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>CI_DOCKERENV=&#39;TEST_RUN=1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>CI_AUTH=&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>CI_WEBPATH=&#39;&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Getting the value of <code>CI_PORT</code> is not as easy as it should be, like using a getter on <code>repo_vars</code> does not work. Fortunately we can use some clever replacements and splits of each item under <code>repo_vars</code> to build a new and usable variable.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=c>{#- Create a real object from repo_vars -#}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>set</span> <span class=nv>better_vars</span><span class=o>={}</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>for</span> <span class=nv>i</span> <span class=k>in</span> <span class=nv>repo_vars</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>set</span> <span class=nv>i</span><span class=o>=(</span><span class=nv>i</span> <span class=o>|</span> <span class=nf>replace</span><span class=o>(</span><span class=s1>&#39; = &#39;</span><span class=o>,</span> <span class=s1>&#39;=&#39;</span><span class=o>,</span> <span class=m>1</span><span class=o>)</span> <span class=o>|</span> <span class=nf>replace</span><span class=o>(</span><span class=s1>&#39;=&#39;</span><span class=o>,</span> <span class=s1>&#39;¯\_(ツ)_/¯&#39;</span><span class=o>,</span> <span class=m>1</span><span class=o>)</span> <span class=o>|</span> <span class=nf>replace</span><span class=o>(</span><span class=s2>&#34;&#39;&#34;</span><span class=o>,</span> <span class=s2>&#34;&#34;</span><span class=o>)</span> <span class=o>|</span> <span class=nf>replace</span><span class=o>(</span><span class=s1>&#39;&#34;&#39;</span><span class=o>,</span> <span class=s2>&#34;&#34;</span><span class=o>))</span><span class=nv>.split</span><span class=o>(</span><span class=s1>&#39;¯\_(ツ)_/¯&#39;</span><span class=o>)</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>set</span> <span class=nv>x</span><span class=o>=(</span><span class=nv>better_vars.__setitem__</span><span class=o>(</span><span class=nv>i</span><span class=o>[</span><span class=m>0</span><span class=o>],</span> <span class=nv>i</span><span class=o>[</span><span class=m>1</span><span class=o>]))</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>endfor</span> -<span class=cp>%}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div><p>The new variable this creates is called <code>better_vars</code>, which is a dictionary-type. I and X is used as throwaway variables, as Jinja does not really have a good way to run straight up code(and with good reason, I imagine). Since <code>repo_vars</code> is a array-type, it serves as a iterator, and saves me from even more <a href="https://www.youtube.com/watch?v=lIFE7h3m40U" target=_blank rel=noopener>bodging</a>. First order of business is to make the list uniform across both ways of placing the equals-sign, after this they don´t have any padding with spaces, I can start replacing and splitting the rest of the line until it has some resemblance of a typical python-like key-value pair.</p><p>In the first iteration of this code, there was no shrug, but a carefully chosen example above highlights how the split would work against us, the macro would fail when it arrived at <code>CI_DOCKERENV</code>, as the value of that key, is a key-value pair.</p><p>We are now working in Python land, so we can remove both double and single quotes, this can come back and bite us later, but as it stands right now this is not an issue. Currently <code>CI_DOCKERENV='TEST_RUN=1'</code> would be <code>CI_DOCKERENV¯\_(ツ)_/¯TEST_RUN=1</code>, this is not useful yet, but we just need to convert this string to a key-value pair, easily done by using <code>¯\_(ツ)_/¯</code> as the deliminator. Once we have this key-value pair we can use the <code>__setitem__</code> function of the built in python <a href=https://docs.python.org/3/reference/datamodel.html#object.__setitem__ target=_blank rel=noopener>dictionary-type</a>.</p><p>After all that there is now a variable that&rsquo;s easier to work with, simply by using a getter.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=c>{# Set the WebUI link based on the link the CI runs against #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>better_vars.get</span><span class=o>(</span><span class=s2>&#34;CI_WEB&#34;</span><span class=o>)</span> <span class=k>and</span> <span class=nv>better_vars.get</span><span class=o>(</span><span class=s2>&#34;CI&#34;</span><span class=o>)</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;WebUI&gt;</span><span class=cp>{{</span> <span class=s2>&#34;https&#34;</span> <span class=k>if</span> <span class=nv>better_vars.get</span><span class=o>(</span><span class=s2>&#34;CI_SSL&#34;</span><span class=o>)</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=k>else</span> <span class=s2>&#34;http&#34;</span> <span class=cp>}}</span><span class=x>://[IP]:[PORT:</span><span class=cp>{{</span> <span class=nv>better_vars.get</span><span class=o>(</span><span class=s2>&#34;CI_PORT&#34;</span><span class=o>)</span> <span class=cp>}}</span><span class=x>]&lt;/WebUI&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div><p>This value is not supposed to hold a real URL, just the parts necessary for Unraid to build one. To do this it needs to know what container port the application is running on, we do this by using the syntax <code>[PORT:80]</code>. Now, if a user maps the container port of 80 to say host port 180, the Unraid webui button would now point to the ip of Unraid with port 180.</p><h4 id=macros-save-the-day>Macros save the day<a hidden class=anchor aria-hidden=true href=#macros-save-the-day>#</a></h4><p>When we told Squid(the guy running Community Applications) to switch us over to the new repo, we actually got <a href=https://github.com/Squidly271/AppFeed/commit/91fd6193070a984efdb7e264e88251a07b450fe6#diff-2ee25025f58fc6dc397dea224c5c4b2d24d1c245efba03f2b2c4035f8e20a46e target=_blank rel=noopener>blacklisted</a> in CA because I forgot how more-than and the less-than sign got treated both by xml and CA(Community Applications) specifically. In CA they are blacklisted characters, simply having them in the user-facing parts of the template gets the whole template repository blacklisted. This prompted a new macro, one to filter out the illegal characters.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span>- <span class=k>macro</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>str</span><span class=o>)</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>str</span> <span class=o>|</span> <span class=nf>replace</span><span class=o>(</span><span class=s2>&#34;&lt;&#34;</span><span class=o>,</span> <span class=s2>&#34;&#34;</span><span class=o>)</span> <span class=o>|</span> <span class=nf>replace</span><span class=o>(</span><span class=s2>&#34;&gt;&#34;</span><span class=o>,</span> <span class=s2>&#34;&#34;</span><span class=o>)</span> <span class=o>|</span> <span class=nf>replace</span><span class=o>(</span><span class=s2>&#34;[&#34;</span><span class=o>,</span> <span class=s2>&#34;&#34;</span><span class=o>)</span> <span class=o>|</span> <span class=nf>replace</span><span class=o>(</span><span class=s2>&#34;]&#34;</span><span class=o>,</span> <span class=s2>&#34;&#34;</span><span class=o>)</span> <span class=o>|</span> <span class=nf>replace</span><span class=o>(</span><span class=s2>&#34;&amp;&#34;</span><span class=o>,</span> <span class=s2>&#34;and&#34;</span><span class=o>)</span> <span class=o>|</span> <span class=nf>escape</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>endmacro</span> -<span class=cp>%}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div><p>This macro simply replaces <code>&lt;</code>, <code>></code>, <code>[</code> and <code>]</code> with nothing, while turning <code>&</code> to a word. For extra safety I put the <a href=https://jinja.palletsprojects.com/en/2.11.x/templates/#escape target=_blank rel=noopener>escape</a> filter at the end. At the time of writing there is no supported syntax in CA to make a hyperlink from a word.
All &ldquo;free text&rdquo; input in the template goes trough this filter to prevent another blacklisting.</p><h4 id=getting-warm>Getting warm<a hidden class=anchor aria-hidden=true href=#getting-warm>#</a></h4><p>Now that I have gotten the taste, and gist of using macros, I made another couple of them to keep myself DRY(Don´t Repeat Yourself)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span>- <span class=k>macro</span> <span class=nv>readme_date</span><span class=o>(</span><span class=nv>str</span><span class=o>)</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>set</span> <span class=nv>_date</span> <span class=o>=</span> <span class=o>(</span><span class=nv>str</span> <span class=o>|</span> <span class=nf>replace</span><span class=o>(</span><span class=s2>&#34;:&#34;</span><span class=o>,</span><span class=s2>&#34;&#34;</span><span class=o>))</span><span class=nv>.split</span><span class=o>(</span><span class=s2>&#34;.&#34;</span><span class=o>)</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=s2>&#34;20&#34;</span> <span class=o>+</span> <span class=nv>_date</span><span class=o>[</span><span class=m>2</span><span class=o>]</span> <span class=o>+</span> <span class=s2>&#34;-&#34;</span> <span class=o>+</span> <span class=nv>_date</span><span class=o>[</span><span class=m>1</span><span class=o>]</span> <span class=o>+</span> <span class=s2>&#34;-&#34;</span> <span class=o>+</span> <span class=nv>_date</span><span class=o>[</span><span class=m>0</span><span class=o>]</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>endmacro</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>macro</span> <span class=nv>mask</span><span class=o>(</span><span class=nv>str</span><span class=o>)</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=s2>&#34;true&#34;</span> <span class=k>if</span> <span class=o>[</span><span class=s2>&#34;token&#34;</span><span class=o>,</span> <span class=s2>&#34;pass&#34;</span> <span class=o>,</span><span class=s2>&#34;key&#34;</span><span class=o>]|</span><span class=nf>select</span><span class=o>(</span><span class=s2>&#34;in&#34;</span><span class=o>,</span> <span class=nv>str</span><span class=o>|</span><span class=nf>lower</span><span class=o>)</span> <span class=k>else</span> <span class=s2>&#34;false&#34;</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>endmacro</span> -<span class=cp>%}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div><p>Since the schema made for CA supports showing a changelog, we might as well use it, the metadata needed is already present in <code>readme-vars.yml</code> so no real work to get the data is needed. As this is the internet, and people come from different places, the dateformat we use is of course incompatible with the one CA accept, so I made a macro to convert <code>mm.dd.yy</code> to <code>yyyy.mm.dd</code>.
Next up is a macro that gets called when creating environment variables, to determine if the variable should be masked.</p><p>Along with a entry to list potential requirements, the changelog macro is used like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span> <span class=k>if</span> <span class=nv>unraid_requirement</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>and</span> <span class=nv>unraid_requirement</span> <span class=p>!</span><span class=o>=</span> <span class=s2>&#34;&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Requires&gt;</span><span class=cp>{{</span> <span class=nv>unraid_requirement</span> <span class=cp>}}</span><span class=x>&lt;/Requires&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{# Create changelog #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>changelogs</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>and</span> <span class=nv>changelogs</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Date&gt;</span><span class=cp>{{</span> <span class=nv>readme_date</span><span class=o>(</span><span class=nv>changelogs</span> <span class=o>|</span><span class=nf>map</span><span class=o>(</span><span class=nv>attribute</span><span class=o>=</span><span class=s1>&#39;date&#39;</span><span class=o>)</span> <span class=o>|</span> <span class=nf>first</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&lt;/Date&gt;
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Changes&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>changelogs</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>### </span><span class=cp>{{</span> <span class=nv>readme_date</span><span class=o>(</span> <span class=nv>item.date</span> <span class=o>)</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>- </span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.desc</span><span class=o>)</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;/Changes&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=the-long-boi>The long boi<a hidden class=anchor aria-hidden=true href=#the-long-boi>#</a></h3><p>Another thing you might want to do with your container is passing along some less common parameters, like memory or cpu limits. This is something I had to tackle with &ldquo;&ldquo;code&rdquo;&rdquo;. As the metadata for this is more literal to the real compose way of writing it, implementing support for security options is also coming.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=c>{#- Create ExtraParam for REQUIRED stuff-#}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>set</span> <span class=nv>ExtraParam</span><span class=o>=[]</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>set</span> <span class=nv>x</span><span class=o>=</span><span class=nv>ExtraParam.append</span><span class=o>(</span><span class=s2>&#34;--hostname=&#34;</span> <span class=o>+</span> <span class=nv>param_hostname</span><span class=o>)</span> <span class=k>if</span> <span class=nv>param_usage_include_hostname</span> <span class=k>is</span> <span class=nf>sameas</span> <span class=kp>true</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>set</span> <span class=nv>x</span><span class=o>=</span><span class=nv>ExtraParam.append</span><span class=o>(</span><span class=s2>&#34;--mac-address=&#34;</span> <span class=o>+</span> <span class=nv>param_mac_address</span><span class=o>)</span> <span class=k>if</span> <span class=nv>param_usage_include_mac_address</span> <span class=k>is</span> <span class=nf>sameas</span> <span class=kp>true</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>if</span> <span class=nv>cap_add_param</span> <span class=k>is</span> <span class=nf>defined</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>cap_add_param_vars</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>set</span> <span class=nv>x</span><span class=o>=</span><span class=nv>ExtraParam.append</span><span class=o>(</span><span class=s2>&#34;--cap-add=&#34;</span> <span class=o>+</span> <span class=nv>item.cap_add_var</span><span class=o>)</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>endfor</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- custom_params -#}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>if</span> <span class=nv>custom_params</span> <span class=k>is</span> <span class=nf>defined</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>custom_params</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>if</span> <span class=nv>item.array</span> <span class=k>is</span> <span class=k>not</span> <span class=nf>defined</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>set</span> <span class=nv>x</span><span class=o>=</span><span class=nv>ExtraParam.append</span><span class=o>(</span><span class=s2>&#34;--&#34;</span> <span class=o>+</span> <span class=nv>item.name</span><span class=o>+</span> <span class=s2>&#34;=&#34;</span> <span class=o>+</span> <span class=nv>item.value</span><span class=o>)</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>else</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>for</span> <span class=nv>item2</span> <span class=k>in</span> <span class=nv>item.value</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>set</span> <span class=nv>x</span><span class=o>=</span><span class=nv>ExtraParam.append</span><span class=o>(</span><span class=s2>&#34;--&#34;</span> <span class=o>+</span> <span class=nv>item.name</span><span class=o>+</span> <span class=s2>&#34;=&#34;</span> <span class=o>+</span> <span class=nv>item2</span><span class=o>)</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>endfor</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>endif</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>endfor</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>endif</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span>- <span class=k>endif</span> -<span class=cp>%}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div><p>This logic defines a variable called <code>ExtraParam</code>, then massages different entries from the metadata, to a array of strings, where each item in the array is a valid docker run argument.</p><h3 id=the-normal-stuff>The normal stuff<a hidden class=anchor aria-hidden=true href=#the-normal-stuff>#</a></h3><p>This article is not written in a chronological order based on the development cycle, rather following the structure in the end product. You can see this by the lack of macros in the rest of the template, if I ever have to do major revisions of this template, turning this into macros would be the first thing to do.</p><h4 id=ports>Ports<a hidden class=anchor aria-hidden=true href=#ports>#</a></h4><p>A good chunk of the applications we bundle, uses multiple ports for different purposes, this is why we have sections in our metadata for optional ports. Thankfully Unraid has the ability to display if a port is optional or not. The schema also exposes the protocol part of a port mapping, a value we also have support for in our metadata. Now we you can see the CA macro in action, it is used to clean characters from our metadata.</p><p>There is a lot of logic present to build the description and name of these ports. It will automatically name the first port as &ldquo;WebUI&rdquo;, or it will fall back to the naming Unraid would use. For the description it will use the one defined in the metadata, or fall back to the value Unraid would have used. Mostly the same logic is used in the optional ports.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=c>{# Set required ports, gets the name from the name atribute if present, or &#34;WebUI&#34; if it is the first port #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>param_usage_include_ports</span> <span class=o>|</span> <span class=nf>default</span><span class=o>(</span><span class=kp>false</span><span class=o>)</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>param_ports</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>set</span> <span class=nv>port</span><span class=o>,</span> <span class=nv>proto</span><span class=o>=</span><span class=nv>item.internal_port.split</span><span class=o>(</span><span class=s1>&#39;/&#39;</span><span class=o>)</span> <span class=k>if</span> <span class=s2>&#34;/&#34;</span> <span class=k>in</span> <span class=nv>item.internal_port</span> <span class=k>else</span> <span class=o>[</span><span class=nv>item.internal_port</span><span class=o>,</span> <span class=kp>false</span><span class=o>]</span> <span class=cp>%}</span><span class=x> </span><span class=c>{#- Logic to get the protocol #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.name</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.name</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;WebUI&#34;</span> <span class=k>if</span> <span class=nb>loop</span><span class=nv>.first</span> <span class=k>else</span> <span class=s2>&#34;Port: &#34;</span> <span class=o>+</span> <span class=nv>port</span> <span class=cp>}}</span><span class=x>&#34; Target=&#34;</span><span class=cp>{{</span> <span class=nv>port</span> <span class=cp>}}</span><span class=x>&#34; Default=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.external_port</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&#34; Mode=&#34;</span><span class=cp>{{</span> <span class=nv>proto</span> <span class=k>if</span> <span class=nv>proto</span> <span class=k>else</span> <span class=s2>&#34;tcp&#34;</span> <span class=cp>}}</span><span class=x>&#34; Description=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.port_desc</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.port_desc</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Container Port: &#34;</span> <span class=o>+</span> <span class=nv>port</span> <span class=cp>}}</span><span class=x>&#34; Type=&#34;Port&#34; Display=&#34;always&#34; Required=&#34;true&#34; Mask=&#34;false&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set required ports, gets the name from the name atribute if present, or &#34;WebUI&#34; if it is the first port #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set optional ports #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>opt_param_usage_include_ports</span> <span class=o>|</span> <span class=nf>default</span><span class=o>(</span><span class=kp>false</span><span class=o>)</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>opt_param_ports</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>set</span> <span class=nv>port</span><span class=o>,</span> <span class=nv>proto</span><span class=o>=</span><span class=nv>item.internal_port.split</span><span class=o>(</span><span class=s1>&#39;/&#39;</span><span class=o>)</span> <span class=k>if</span> <span class=s2>&#34;/&#34;</span> <span class=k>in</span> <span class=nv>item.internal_port</span> <span class=k>else</span> <span class=o>[</span><span class=nv>item.internal_port</span><span class=o>,</span> <span class=kp>false</span><span class=o>]</span> <span class=cp>%}</span><span class=x> </span><span class=c>{#- Logic to get the protocol #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.name</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.name</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Port: &#34;</span> <span class=o>+</span> <span class=nv>port</span> <span class=cp>}}</span><span class=x>&#34; Target=&#34;</span><span class=cp>{{</span> <span class=nv>port</span> <span class=cp>}}</span><span class=x>&#34; Default=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.external_port</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&#34; Mode=&#34;</span><span class=cp>{{</span> <span class=nv>proto</span> <span class=k>if</span> <span class=nv>proto</span> <span class=k>else</span> <span class=s2>&#34;tcp&#34;</span> <span class=cp>}}</span><span class=x>&#34; Description=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.port_desc</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.port_desc</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Container Port: &#34;</span> <span class=o>+</span> <span class=nv>port</span> <span class=cp>}}</span><span class=x>&#34; Type=&#34;Port&#34; Display=&#34;always&#34; Required=&#34;false&#34; Mask=&#34;false&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set optional ports #}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=volumes>Volumes<a hidden class=anchor aria-hidden=true href=#volumes>#</a></h4><p>The logic used for volumes is pretty much a copy-paste from the ports-logic, but instead of looking &ldquo;WebUI&rdquo;, it is trying to find a volume to call &ldquo;Appdata&rdquo;. There is also a piece of extra logic to see if a bind-volume is marked as Read Only.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=c>{#- Set required volumes, gets the name from the name atribute if present, or &#34;Appdata&#34; if it is the /config location #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>param_usage_include_vols</span> <span class=o>|</span> <span class=nf>default</span><span class=o>(</span><span class=kp>false</span><span class=o>)</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>param_volumes</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>set</span> <span class=nv>path</span><span class=o>,</span> <span class=nv>mode</span><span class=o>=</span><span class=nv>item.vol_path.split</span><span class=o>(</span><span class=s1>&#39;:&#39;</span><span class=o>)</span> <span class=k>if</span> <span class=s2>&#34;:&#34;</span> <span class=k>in</span> <span class=nv>item.vol_path</span> <span class=k>else</span> <span class=o>[</span><span class=nv>item.vol_path</span><span class=o>,</span> <span class=kp>false</span><span class=o>]</span> <span class=cp>%}</span><span class=x> </span><span class=c>{#- Logic to get the mode #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.name</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.name</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Appdata&#34;</span> <span class=k>if</span> <span class=nv>path</span> <span class=o>==</span> <span class=s2>&#34;/config&#34;</span> <span class=k>else</span> <span class=s2>&#34;Path: &#34;</span> <span class=o>+</span> <span class=nv>path</span> <span class=cp>}}</span><span class=x>&#34; Target=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>path</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&#34; Default=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.vol_host_path</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.default</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>and</span> <span class=nv>item.default</span> <span class=k>is</span> <span class=nf>sameas</span> <span class=kp>true</span> <span class=cp>}}</span><span class=x>&#34; Mode=&#34;</span><span class=cp>{{</span> <span class=nv>mode</span> <span class=k>if</span> <span class=nv>mode</span> <span class=k>else</span> <span class=s2>&#34;rw&#34;</span> <span class=cp>}}</span><span class=x>&#34; Description=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.desc</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.desc</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Path: &#34;</span> <span class=o>+</span> <span class=nv>path</span> <span class=cp>}}</span><span class=x>&#34; Type=&#34;Path&#34; Display=&#34;</span><span class=cp>{{</span> <span class=s2>&#34;advanced&#34;</span> <span class=k>if</span> <span class=nv>path</span> <span class=o>==</span> <span class=s2>&#34;/config&#34;</span> <span class=k>else</span> <span class=s2>&#34;always&#34;</span> <span class=cp>}}</span><span class=x>&#34; Required=&#34;true&#34; Mask=&#34;false&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set required volumes, gets the name from the name atribute if present, or &#34;Appdata&#34; if it is the /config location #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set optional volumes #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>opt_param_usage_include_vols</span> <span class=o>|</span> <span class=nf>default</span><span class=o>(</span><span class=kp>false</span><span class=o>)</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>opt_param_volumes</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>set</span> <span class=nv>path</span><span class=o>,</span> <span class=nv>mode</span><span class=o>=</span><span class=nv>item.vol_path.split</span><span class=o>(</span><span class=s1>&#39;:&#39;</span><span class=o>)</span> <span class=k>if</span> <span class=s2>&#34;:&#34;</span> <span class=k>in</span> <span class=nv>item.vol_path</span> <span class=k>else</span> <span class=o>[</span><span class=nv>item.vol_path</span><span class=o>,</span> <span class=kp>false</span><span class=o>]</span> <span class=cp>%}</span><span class=x> </span><span class=c>{#- Logic to get the mode #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.name</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.name</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Appdata&#34;</span> <span class=k>if</span> <span class=nv>path</span> <span class=o>==</span> <span class=s2>&#34;/config&#34;</span> <span class=k>else</span> <span class=s2>&#34;Path: &#34;</span> <span class=o>+</span> <span class=nv>path</span> <span class=cp>}}</span><span class=x>&#34; Target=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>path</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&#34; Default=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.vol_host_path</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.default</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>and</span> <span class=nv>item.default</span> <span class=k>is</span> <span class=nf>sameas</span> <span class=kp>true</span> <span class=cp>}}</span><span class=x>&#34; Mode=&#34;</span><span class=cp>{{</span> <span class=nv>mode</span> <span class=k>if</span> <span class=nv>mode</span> <span class=k>else</span> <span class=s2>&#34;rw&#34;</span> <span class=cp>}}</span><span class=x>&#34; Description=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.desc</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.desc</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Path: &#34;</span> <span class=o>+</span> <span class=nv>path</span> <span class=cp>}}</span><span class=x>&#34; Type=&#34;Path&#34; Display=&#34;always&#34; Required=&#34;false&#34; Mask=&#34;false&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set optional volumes #}</span><span class=x>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=variables>Variables<a hidden class=anchor aria-hidden=true href=#variables>#</a></h4><p>The base of the logic for variables is also based on the ports-logic, but it does filter away some variables we hardcode, or variables that Unraid automatically manages.</p><p>The id´s for puid and guid in Unraid, is following a agreed upon id from the early days, the 99 user is ´nobody´.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span> <span class=k>set</span> <span class=nv>skip_envs</span><span class=o>=[</span><span class=s2>&#34;puid&#34;</span><span class=o>,</span> <span class=s2>&#34;pgid&#34;</span><span class=o>,</span> <span class=s2>&#34;tz&#34;</span><span class=o>,</span> <span class=s2>&#34;umask&#34;</span><span class=o>]</span> <span class=cp>%}</span><span class=x> </span><span class=c>{#- Drop envs that are either hardcoded, or automaticcly added by unraid #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set required variables, gets the name from the name atribute #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>param_usage_include_env</span> <span class=o>|</span> <span class=nf>default</span><span class=o>(</span><span class=kp>false</span><span class=o>)</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>param_env_vars</span> <span class=k>if</span> <span class=k>not</span> <span class=nv>item.env_var</span> <span class=o>|</span> <span class=nf>lower</span> <span class=k>is</span> <span class=nf>in</span> <span class=nv>skip_envs</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.name</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.name</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=nv>item.env_var</span> <span class=cp>}}</span><span class=x>&#34; Target=&#34;</span><span class=cp>{{</span> <span class=nv>item.env_var</span> <span class=cp>}}</span><span class=x>&#34; Default=&#34;</span><span class=cp>{{</span> <span class=nv>item.env_options</span> <span class=o>|</span> <span class=nf>join</span><span class=o>(</span><span class=s1>&#39;|&#39;</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.env_options</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.env_value</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&#34; Description=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.desc</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.desc</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Variable: &#34;</span> <span class=o>+</span> <span class=nv>path</span> <span class=cp>}}</span><span class=x>&#34; Type=&#34;Variable&#34; Display=&#34;always&#34; Required=&#34;true&#34; Mask=&#34;</span><span class=cp>{{</span> <span class=nv>mask</span><span class=o>(</span><span class=nv>item.env_var</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set required variables, gets the name from the name atribute #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set optional variables #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>opt_param_usage_include_env</span> <span class=o>|</span> <span class=nf>default</span><span class=o>(</span><span class=kp>false</span><span class=o>)</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>opt_param_env_vars</span> <span class=k>if</span> <span class=k>not</span> <span class=nv>item.env_var</span> <span class=o>|</span> <span class=nf>lower</span> <span class=k>is</span> <span class=nf>in</span> <span class=nv>skip_envs</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.name</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.name</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=nv>item.env_var</span> <span class=cp>}}</span><span class=x>&#34; Target=&#34;</span><span class=cp>{{</span> <span class=nv>item.env_var</span> <span class=cp>}}</span><span class=x>&#34; Default=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.env_value</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&#34; Description=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.desc</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.desc</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Variable: &#34;</span> <span class=o>+</span> <span class=nv>path</span> <span class=cp>}}</span><span class=x>&#34; Type=&#34;Variable&#34; Display=&#34;always&#34; Required=&#34;false&#34; Mask=&#34;</span><span class=cp>{{</span> <span class=nv>mask</span><span class=o>(</span><span class=nv>item.env_var</span><span class=o>)</span> <span class=cp>}}</span><span class=x>&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set optional variables #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;PUID&#34; Target=&#34;PUID&#34; Default=&#34;99&#34; Description=&#34;Container Variable: PUID&#34; Type=&#34;Variable&#34; Display=&#34;advanced&#34; Required=&#34;true&#34; Mask=&#34;false&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;PGID&#34; Target=&#34;PGID&#34; Default=&#34;100&#34; Description=&#34;Container Variable: PGID&#34; Type=&#34;Variable&#34; Display=&#34;advanced&#34; Required=&#34;true&#34; Mask=&#34;false&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;UMASK&#34; Target=&#34;UMASK&#34; Default=&#34;022&#34; Description=&#34;Container Variable: UMASK&#34; Type=&#34;Variable&#34; Display=&#34;advanced&#34; Required=&#34;false&#34; Mask=&#34;false&#34;/&gt;
</span></span></span></code></pre></td></tr></table></div></div><h4 id=devices>Devices<a hidden class=anchor aria-hidden=true href=#devices>#</a></h4><p>The logic for devices is also very similar, without any special treatment.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=c>{# Set required devices, gets the name from the name atribute #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>param_device_map</span> <span class=o>|</span> <span class=nf>default</span><span class=o>(</span><span class=kp>false</span><span class=o>)</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>param_devices</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.name</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.name</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=nv>item.device_path</span> <span class=cp>}}</span><span class=x>&#34; Default=&#34;</span><span class=cp>{{</span> <span class=nv>item.device_path</span> <span class=cp>}}</span><span class=x>&#34; Description=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.desc</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.desc</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Device: &#34;</span> <span class=o>+</span> <span class=nv>path</span> <span class=cp>}}</span><span class=x>&#34; Type=&#34;Device&#34; Display=&#34;always&#34; Required=&#34;true&#34; Mask=&#34;false&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set required variables, gets the name from the name atribute #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set optional devices #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>if</span> <span class=nv>opt_param_device_map</span> <span class=o>|</span> <span class=nf>default</span><span class=o>(</span><span class=kp>false</span><span class=o>)</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>item</span> <span class=k>in</span> <span class=nv>opt_param_devices</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    &lt;Config Name=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.name</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.name</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=nv>item.device_path</span> <span class=cp>}}</span><span class=x>&#34; Default=&#34;</span><span class=cp>{{</span> <span class=nv>item.device_path</span> <span class=cp>}}</span><span class=x>&#34; Description=&#34;</span><span class=cp>{{</span> <span class=nv>ca</span><span class=o>(</span><span class=nv>item.desc</span><span class=o>)</span> <span class=k>if</span> <span class=nv>item.desc</span> <span class=k>is</span> <span class=nf>defined</span> <span class=k>else</span> <span class=s2>&#34;Device: &#34;</span> <span class=o>+</span> <span class=nv>path</span> <span class=cp>}}</span><span class=x>&#34; Type=&#34;Device&#34; Display=&#34;always&#34; Required=&#34;false&#34; Mask=&#34;false&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{#- Set optional devices #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>&lt;/Container&gt;
</span></span></span></code></pre></td></tr></table></div></div><h3 id=finishing-up>Finishing up<a hidden class=anchor aria-hidden=true href=#finishing-up>#</a></h3><p>The last step is to tie this template into the Ansible play, which I won´t cover here, as it´s not a bodge, like this template is.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://nonsense.fyi/tags/automation/>Automation</a></li><li><a href=https://nonsense.fyi/tags/linuxserver.io/>Linuxserver.io</a></li></ul><nav class=paginav><a class=prev href=https://nonsense.fyi/posts/road-to-ckad/><span class=title>« Prev</span><br><span>Road to CKAD</span>
</a><a class=next href=https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/><span class=title>Next »</span><br><span>Deploying Loki and Promtail Together With the TIG Stack</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Templating templates with templates on x" href="https://x.com/intent/tweet/?text=Templating%20templates%20with%20templates&amp;url=https%3a%2f%2fnonsense.fyi%2fposts%2ftemplating-templates-with-templates%2f&amp;hashtags=Automation%2cLinuxserver.io"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Templating templates with templates on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnonsense.fyi%2fposts%2ftemplating-templates-with-templates%2f&amp;title=Templating%20templates%20with%20templates&amp;summary=Templating%20templates%20with%20templates&amp;source=https%3a%2f%2fnonsense.fyi%2fposts%2ftemplating-templates-with-templates%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Templating templates with templates on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnonsense.fyi%2fposts%2ftemplating-templates-with-templates%2f&title=Templating%20templates%20with%20templates"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Templating templates with templates on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnonsense.fyi%2fposts%2ftemplating-templates-with-templates%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Templating templates with templates on whatsapp" href="https://api.whatsapp.com/send?text=Templating%20templates%20with%20templates%20-%20https%3a%2f%2fnonsense.fyi%2fposts%2ftemplating-templates-with-templates%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Templating templates with templates on telegram" href="https://telegram.me/share/url?text=Templating%20templates%20with%20templates&amp;url=https%3a%2f%2fnonsense.fyi%2fposts%2ftemplating-templates-with-templates%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Templating templates with templates on ycombinator" href="https://news.ycombinator.com/submitlink?t=Templating%20templates%20with%20templates&u=https%3a%2f%2fnonsense.fyi%2fposts%2ftemplating-templates-with-templates%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=Roxedus/nonsense.fyi data-repo-id="MDEwOlJlcG9zaXRvcnkyNTkxMzY1NDE=" data-category=Announcements data-category-id=DIC_kwDOD3IcHc4B-8g4 data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=preferred_color_scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://nonsense.fyi/>nonsense.fyi</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><div id=current-visitors-container></div><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>