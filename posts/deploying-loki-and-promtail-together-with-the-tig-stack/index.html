<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Deploying Loki and Promtail Together With the TIG Stack | nonsense.fyi</title>
<meta name=keywords content="Automation">
<meta name=description content="How to set up Loki, Promtail, Telegraf and Grafana to visualize logs and system stats.">
<meta name=author content="Roxedus">
<link rel=canonical href=https://nonsense.fyi/posts/Deploying-Loki-and-Promtail-together-with-the-TIG-stack>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.6f60056d44d3f7eb69a4bc6c332b59960f3a995802bded244750232f33713c49.css integrity="sha256-b2AFbUTT9+tppLxsMytZlg86mVgCve0kR1AjLzNxPEk=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://nonsense.fyi/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://nonsense.fyi/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://nonsense.fyi/favicon-32x32.png>
<link rel=apple-touch-icon href=https://nonsense.fyi/apple-touch-icon.png>
<link rel=mask-icon href=https://nonsense.fyi/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.87.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<link rel=preconnect href=https://hosted.roxedus.net>
<script defer data-domain="{{ .Site.title }}" src=https://hosted.roxedus.net/js/index.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script>
<script></script>
<meta property="og:title" content="Deploying Loki and Promtail Together With the TIG Stack">
<meta property="og:description" content="How to set up Loki, Promtail, Telegraf and Grafana to visualize logs and system stats.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/">
<meta property="og:image" content="https://nonsense.fyi/images/cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-06-02T00:00:00+02:00">
<meta property="article:modified_time" content="2020-06-02T00:00:00+02:00"><meta property="og:site_name" content="{{ .Site.title }}">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://nonsense.fyi/images/cover.png">
<meta name=twitter:title content="Deploying Loki and Promtail Together With the TIG Stack">
<meta name=twitter:description content="How to set up Loki, Promtail, Telegraf and Grafana to visualize logs and system stats.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://nonsense.fyi/posts/"},{"@type":"ListItem","position":2,"name":"Deploying Loki and Promtail Together With the TIG Stack","item":"https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Deploying Loki and Promtail Together With the TIG Stack","name":"Deploying Loki and Promtail Together With the TIG Stack","description":"How to set up Loki, Promtail, Telegraf and Grafana to visualize logs and system stats.","keywords":["Automation"],"articleBody":"Now that I have set up this server as I want, the next step is to ensure it stays this way. One of the things I do to achieve this, is by setting up monitoring, and yes, it is very overkill for this setup. I went with a set of tools that I know, with some new additions which has been on my list of things to look into for a while, mainly Loki and Promtail. They are both projects from Grafana which are heavily focused on logs, both presenting them and parse them.\nI’m basing this on the TIG(Telegraf, InfluxDB, Grafana) stack, because I didn’t want to spend time learning Prometheus, however implementing this took more time than it should’ve, Loki even got updated while setting it up. As I said earlier, I wanted to add some new tools in my “normal” stack. Just because Telegraf can do logs, does not mean it should. It can handle both syslog with a syslog-listener plugin, and docker-logs with the use of the docker socket, but Grafana has no good way of presenting them (I don’t blame them).\n Setting up InfluxDB Setting up InfluxDB in docker is quite easy. This is all it takes.\ninfluxdb: image: influxdb:latest container_name: influxdb environment: - TZ=${TZ} ports: - 127.0.0.1:8086:8086 volumes: - /opt/appdata/influxdb/:/var/lib/influxdb restart: unless-stopped  Setting up Telegraf Again, I choose to have a service running on the host, rather than in a container. I did this because Fail2Ban run on the host, having a container talking to a service on the host when the Telegraf plugin uses the command-line to interface with the service sounded like an unnecessary challenge.\nMy telegraf.conf is relatively small, only because I added the sections I were going to use, rather than using the one included which has all the options in it. Depending on your experience with Telegraf, it might look a bit complicated, especially the outputs. It is in fact not that advanced.\n[[outputs.influxdb]] database = \"telegraf\" # required retention_policy = \"\" write_consistency = \"any\" timeout = \"5s\" [outputs.influxdb.tagdrop] influx_database = [\"docker\", \"nginx\", \"system\", \"web\"] [[outputs.influxdb]] database = \"system\" # required retention_policy = \"\" write_consistency = \"any\" timeout = \"5s\" tagexclude = [\"influx_database\"] [outputs.influxdb.tagpass] influx_database = [\"system\"] This is mainly doing two things, to achieve the goal of diverting each type of metric into their own database in InfluxDB. Having them all in the same one isn’t really a problem; it just makes it easier for me. To do this Telegraf has to add a tag to the metric it collects.\n[[inputs.cpu]] percpu = true totalcpu = true collect_cpu_time = false report_active = false [inputs.cpu.tags] influx_database = \"system\" Here I tell Telegraf to tag all the metrics from the cpu input with the tag influx_database set to system. Telegraf can use the tagpass and tagdrop to further filter the metrics. We use tagpass to tell Telegraf which tags this output should allow. In the example I tell it to allow all metrics tagged with influx_database set to system. The tagdrop does the opposite, it tells Telegraf which tags it should not allow. In order to keep the output somewhat clean, I tell Telegraf to not pass the influx_database tag to InfluxDB.\nOther than configuring nginx to show nginx_stub status on 127.0.0.1:8080, the rest of the telegraf.conf is pretty much stock.\nserver { listen 127.0.0.1:8080; location / { stub_status on; access_log off; } }  Setting up Grafana I noticed a while back, that you can configure Grafana purely by using enviroment variables, this is awesome because it can also be set up to not use the embedded sqlite database. Which means I don’t need to give it a volume mount for persistent data, I did however give it a mount for using the socket instead of using http between nginx and Grafana.\ngrafana: image: grafana/grafana:latest container_name: grafana hostname: ${HOSTNAME} user: \"1000:33\" environment: - TZ=${TZ} - GF_AUTH_ANONYMOUS_ENABLED=true - GF_AUTH_ANONYMOUS_ORG_NAME=Nonsense - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer - GF_DATABASE_URL=mysql://grafana:${GrafanaDB_PASS}@mariadb/grafana - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-worldmap-panel,grafana-piechart-panel - GF_SECURITY_ADMIN_USER=Roxedus - GF_SECURITY_ALLOW_EMBEDDING=true - GF_SECURITY_COOKIE_SECURE=true - GF_SERVER_PROTOCOL=socket - GF_SERVER_SOCKET=/opt/socket/grafana.socket # - GF_SECURITY_ADMIN_PASSWORD=${SQL_ROOT} volumes: - /opt/socket/:/opt/socket I renamed the default organization in Grafana, which means that the default anonymous(guest) access break. I fix that by declaring which organization and role the anonymous user is attached to. Then I tell Grafana how to connect to the database, and what plugins it should install on start. Since I can, I also set the admin username and password, instead of updating the user after the fact.\nUnlike Ghost, Grafana doesnt have a way to set permissions on the socket. Therefore, Grafana runs as my user, as part of the www-data group. It is dirty, but it works.\n Reading a simple logfile with Promtail The next part was getting Loki and Promtail set up. Oh boy what a task this was. I don’t know why, but there isn’t much content about this out there, if I were to guess people run the whole ELK stack. Which is way overkill for what I want to achieve here. The biggest hurdle personally was the fact that it was written in go, and therefore the config used some go-specific rules. Did you know that go’s implementation of regex is very minimal? Or that the time-formatting is done without the notion of deliminators like YYYY-MM-DD? I for sure did not.\nGetting the containers running was pretty simple, once you have downloaded the basic configuration files for Loki and Promtail. I choice to not use the default location inside the containers, I followed the practice of having all persistent data inn /config since I can override the config.file location with the command feature of docker.\nloki: image: grafana/loki:${LOKI_VER} hostname: ${HOSTNAME} container_name: loki environment: - TZ=${TZ} volumes: - /opt/appdata/loki/config:/config:ro command: -config.file=/config/loki-config.yaml promtail: image: grafana/promtail:${LOKI_VER} container_name: promtail environment: - TZ=${TZ} depends_on: - loki volumes: - /opt/appdata/promtail:/config:ro - /opt/logs:/opt/logs:ro - /var/log:/var/log:ro - /etc/machine-id:/etc/machine-id:ro command: -config.file=/config/promtail-config.yaml My Loki service is not too far off from the example Loki provides. I added the hostname for the machine and set the TZ. I will come back to the logging part later.\nFor Promtail I gave it two volume-mounts for logs, where /opt/logs is where the logs from the applications I run with Docker are located (not to be confused with docker logs). The next thing I did was to change the promtail-config.yaml file to tell Promtail to read the logs in /opt.\nserver: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /tmp/positions.yaml clients: - url: http://loki:3100/loki/api/v1/push scrape_configs: - job_name: system pipeline_stages: static_configs: - targets: - localhost labels: job: varlogs __path__: /var/log/**/**log - targets: - localhost labels: job: containers __path__: /opt/logs/**/*log I could have added the __path__ to the varlogs job, but I added it as a new job to be able to filter it out easily in Grafana. They would present themselves something like this:\nAs well as labeling the data with the job-name, it also labels it with the filename, which is neat when you want to focus on a specific logfile. If you look closely you can see that Loki didn’t read the timestamp properly. This is something we can fix manually and depending on the original time-format its not that difficult, after getting over the hurdles that is go’s time-formatting. The documentation does cover it, but it takes a few clicks to get there, so here is a link. There is a catch here though, especially if you know language like python. go’s time-formater doesn’t handle milliseconds with commas, there is an issue open about this from 2013.\n 2021 Note: Looks like this is no longer the case\n You can still get the timestamp, but there is an additional step that need to be taken for that. I ran into that issue with the fail2ban logs, and I will walk you trough how I solved it. Here is a line from that log.\n2020-05-27 21:51:50,138 fail2ban.filter [9474]: INFO [sshd] Found 1.1.1.1 - 2020-05-27 21:51:50 The first thing that had to be done was extracting the timestamp from the line. This is done with a regex stage. Note the that the backslashes needs to be escaped.\n- regex: expression: \"(?P\\\\d{4}-\\\\d{2}-\\\\d{2} \\\\d{2}:\\\\d{2}:\\\\d{2},\\\\d{0,3}) (?Pfail2ban.*(?P\\\\[\\\\d*\\\\]: )(?P[A-Z]{4,7}) .*)\" I am also going to be extracting a few other things, like the message itself, the PID and the log-level, to use in other stages. You can look at the regex in action on regex101.com.\nNow I can use the content of time group as a variable in Promtail. The next step is to replace the comma with a dot, so Promtail can understand the time-format. This is done with a template step. That is another thing worth looking into, go’s template system. After reading about the replace function on the string function, it was pretty clear that it was the last piece of the puzzle I needed to solve before putting it all together.\n- template: source: time template: '{{ Replace .Value \",\" \".\" -1 }}' Now we have the time variable available, because all the capture groups created with the regex step is exported for us to use. I pass it to the template. .Value is the value from the variable set as source. Then it replaces , with . for -1 times, -1 is the same as replace all. The output of this step is a new time variable, same name, new content. We can now define the timestamp in the next stage.\n- timestamp: source: time format: \"2006-01-02 15:04:05.000\" This is how you define a time-format in GO. This is it. It is a clever way to do it, it uses a set value for each component. The year it looks for is 2006, so it’s either 06 or 2006. The month has a few more options 1, 01, Jan or January. So, in a sense it is all pretty easy to read. All the possibilities for the components are in the documentation for the timestamp stage.\nNow Promtail know what time the log was sent for.\nI am not happy with the result; it has data I don’t need, there is more I can do. If you look at the initial line from the log, it also has the time at the end, neither do I need the PID. I can fix this with another template step and a regex step.\n- template: source: message template: '{{ Replace .Value .pid \"\" -1 }}' In this stage it reads the message extracted from the initial regex, then it replaces the content of the capture-group/label called pid with nothing.\n- regex: expression: '(?P.*)(?: - \\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2})' source: message This regex step uses the message passed from the previous template step and creates a new message capture-group, the important thing here is that it places the eventual timestamp in its own capture group, which is not a part of the message group.\nIf I were to start Promtail now, it would still see the line as it is in the log. Promtail needs to be told what it should be passing along, so we use the output stage.\n- output: source: message However it also needs to be told what to apply all these steps to, so a final configuration to get Promtail to read and parse the Fail2Ban log would look something like this.\nserver: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /tmp/positions.yaml clients: - url: http://loki:3100/loki/api/v1/push scrape_configs: - job_name: system pipeline_stages: - match: selector: '{filename=~\".*fail2ban.log\"}' stages: - regex: expression: \"(?P\\\\d{4}-\\\\d{2}-\\\\d{2} \\\\d{2}:\\\\d{2}:\\\\d{2},\\\\d{0,3})?\\\\D? (?Pfail2ban.*(?P\\\\[\\\\d*\\\\]: )(?P[A-Z]{4,7}) .* (?:(?:\\\\[|Jail ')(?P\\\\D*)(?:\\\\]|'))?.*)\" - template: source: message template: '{{ Replace .Value .pid \"\" -1 }}' - regex: expression: '(?P.*)(?: - \\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2})' source: message - template: source: time template: '{{ Replace .Value \",\" \".\" -1 }}' - timestamp: source: time format: \"2006-01-02 15:04:05.000\" - output: source: message static_configs: - targets: - localhost labels: job: varlogs __path__: /var/log/**/**log - targets: - localhost labels: job: containers __path__: /opt/logs/**/*log In order for Promtail to know where to apply these stages, it needs to match it to something. Grafana is then again presenting a new concept with Loki, LogQL. It is an adaptation of Prometheus' query language, focused on logs. This is used in the selector, I kept mine simple. It is only matching against filenames ending with fail2ban.log, the filename includes paths, which is why there is a wildcard in front.\n Reading docker-logs with Promtail Loki has a docker log-driver, which as the time of writing has a few deal breaking issues, mainly #2017. To work around this, I found that sending docker-logs to the journal works for my use case. The Promtail config for this was surprisingly easy, by just setting up the journal job example from Promtails documentation.\nserver: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /tmp/positions.yaml clients: - url: http://loki:3100/loki/api/v1/push scrape_configs: - job_name: system pipeline_stages: - job_name: journal journal: max_age: 12h labels: job: systemd-journal relabel_configs: - source_labels: [\"__journal__systemd_unit\"] target_label: \"unit\" That will give us the journal from the host since /var/log/journal is mapped.\nThere is a few ways to tell docker to log to the journal, however I am going to do it in my docker-compose. I simply just add a few lines to the containers I want to see in Grafana.\nlogging: driver: journald options: mode: non-blocking My Matomo instance would then look something like this.\nmatomo: image: matomo:fpm-alpine container_name: matomo logging: driver: journald options: mode: non-blocking depends_on: - mariadb volumes: - /opt/appdata/matomo:/var/www/html - /opt/logs/matomo:/logz Now I can see the logs from the Matomo container in Grafana, however it does not have a label I can use to sort out all the entries which does not come from the container. I can do that by adding a relabel action in the job-definition. Promtail presents all metadata from the journal with the __journal_ label-prefix. This means that we can access the CONTAINER_NAME attribute docker adds to the logfile with the label __journal_container_name, so by adding a relabel_config we can get the container name as a label in Promtail.\nserver: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /tmp/positions.yaml clients: - url: http://loki:3100/loki/api/v1/push scrape_configs: - job_name: system pipeline_stages: - job_name: journal journal: max_age: 12h labels: job: systemd-journal relabel_configs: - source_labels: [\"__journal__systemd_unit\"] target_label: \"unit\" - source_labels: [\"__journal_container_name\"] target_label: \"container\" It will present the logs similar to this:\n","wordCount":"2341","inLanguage":"en","image":"https://nonsense.fyi/images/cover.png","datePublished":"2020-06-02T00:00:00+02:00","dateModified":"2020-06-02T00:00:00+02:00","author":{"@type":"Person","name":"Roxedus"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/"},"publisher":{"@type":"Organization","name":"nonsense.fyi","logo":{"@type":"ImageObject","url":"https://nonsense.fyi/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://nonsense.fyi/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://nonsense.fyi/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://nonsense.fyi/tags/ title=tags>
<span>tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://nonsense.fyi/>Home</a>&nbsp;»&nbsp;<a href=https://nonsense.fyi/posts/>Posts</a></div>
<h1 class=post-title>
Deploying Loki and Promtail Together With the TIG Stack
</h1>
<div class=post-description>
How to set up Loki, Promtail, Telegraf and Grafana to visualize logs and system stats.
</div>
<div class=post-meta>June 2, 2020&nbsp;·&nbsp;11 min&nbsp;·&nbsp;Roxedus&nbsp;|&nbsp;<a href=https://github.com/Roxedus/nonsense.fyi/edit/main/content/posts/Deploying%20Loki%20and%20Promtail%20together%20with%20the%20TIG%20stack/index.md rel="noopener noreferrer" target=_blank>Correct my grammar!</a>
</div>
</header>
<figure class=entry-cover><a href=https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/images/cover.png target=_blank rel="noopener noreferrer">
<img loading=lazy srcset="https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/images/cover_hu0de0f290278ff84b7aff1421dafa8810_969327_360x0_resize_box_3.png 360w ,https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/images/cover_hu0de0f290278ff84b7aff1421dafa8810_969327_480x0_resize_box_3.png 480w ,https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/images/cover_hu0de0f290278ff84b7aff1421dafa8810_969327_720x0_resize_box_3.png 720w ,https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/images/cover_hu0de0f290278ff84b7aff1421dafa8810_969327_1080x0_resize_box_3.png 1080w ,https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/images/cover_hu0de0f290278ff84b7aff1421dafa8810_969327_1500x0_resize_box_3.png 1500w ,https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/images/cover.png 2000w" sizes="(min-width: 768px) 720px, 100vw" src=https://nonsense.fyi/posts/deploying-loki-and-promtail-together-with-the-tig-stack/images/cover.png alt="Visualization of a promtail dashboard in Grafana" width=2000 height=842></a>
<p>Visualization of a promtail dashboard in Grafana</p>
</figure><div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#setting-up-influxdb aria-label="Setting up InfluxDB">Setting up InfluxDB</a></li>
<li>
<a href=#setting-up-telegraf aria-label="Setting up Telegraf">Setting up Telegraf</a></li>
<li>
<a href=#setting-up-grafana aria-label="Setting up Grafana">Setting up Grafana</a></li>
<li>
<a href=#reading-a-simple-logfile-with-promtail aria-label="Reading a simple logfile with Promtail">Reading a simple logfile with Promtail</a></li>
<li>
<a href=#reading-docker-logs-with-promtail aria-label="Reading docker-logs with Promtail">Reading docker-logs with Promtail</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>Now that I have set up this server as I want, the next step is to ensure it stays this way. One of the things I do to achieve this, is by setting up monitoring, and yes, it is very overkill for this setup. I went with a set of tools that I know, with some new additions which has been on my list of things to look into for a while, mainly <a href=https://github.com/grafana/loki/tree/master>Loki</a> and Promtail. They are both projects from <a href=https://github.com/grafana>Grafana</a> which are heavily focused on logs, both presenting them and parse them.</p>
<p>I&rsquo;m basing this on the TIG(<a href=https://github.com/influxdata/telegraf>Telegraf</a>, <a href=https://github.com/influxdata/influxdb>InfluxDB</a>, <a href=https://github.com/grafana>Grafana</a>) stack, because I didn&rsquo;t want to spend time learning Prometheus, however implementing this took more time than it should&rsquo;ve, Loki even got updated while setting it up. As I said earlier, I wanted to add some new tools in my &ldquo;normal&rdquo; stack. Just because Telegraf can do logs, does not mean it should. It can handle both syslog with a syslog-listener plugin, and docker-logs with the use of the docker socket, but Grafana has no good way of presenting them (I don&rsquo;t blame them).</p>
<hr>
<h1 id=setting-up-influxdb>Setting up InfluxDB<a hidden class=anchor aria-hidden=true href=#setting-up-influxdb>#</a></h1>
<p>Setting up InfluxDB in docker is quite easy. This is all it takes.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>  <span style=color:#f92672>influxdb</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>influxdb:latest</span>
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>influxdb</span>
    <span style=color:#f92672>environment</span>:
      - <span style=color:#ae81ff>TZ=${TZ}</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#ae81ff>127.0.0.1</span>:<span style=color:#ae81ff>8086</span>:<span style=color:#ae81ff>8086</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>/opt/appdata/influxdb/:/var/lib/influxdb</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</code></pre></div><hr>
<h1 id=setting-up-telegraf>Setting up Telegraf<a hidden class=anchor aria-hidden=true href=#setting-up-telegraf>#</a></h1>
<p>Again, I choose to have a service running on the host, rather than in a container. I did this because Fail2Ban run on the host, having a container talking to a service on the host when the Telegraf plugin uses the command-line to interface with the service sounded like an unnecessary challenge.</p>
<p>My <code>telegraf.conf</code> is relatively small, only because I added the sections I were going to use, rather than using the one included which has all the options in it. Depending on your experience with Telegraf, it might look a bit complicated, especially the outputs. It is in fact not that advanced.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#66d9ef>[[outputs.influxdb]]</span>
  <span style=color:#a6e22e>database</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;telegraf&#34; # required</span>

  <span style=color:#a6e22e>retention_policy</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;
</span><span style=color:#e6db74>  write_consistency = &#34;any&#34;</span>

  <span style=color:#a6e22e>timeout</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5s&#34;
</span><span style=color:#e6db74>  [outputs.influxdb.tagdrop]
</span><span style=color:#e6db74>    influx_database = [&#34;docker&#34;, &#34;nginx&#34;, &#34;system&#34;, &#34;web&#34;]</span>

<span style=color:#66d9ef>[[outputs.influxdb]]</span>
  <span style=color:#a6e22e>database</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;system&#34; # required
</span><span style=color:#e6db74>  retention_policy = &#34;&#34;
</span><span style=color:#e6db74>  write_consistency = &#34;any&#34;
</span><span style=color:#e6db74>  timeout = &#34;5s&#34;
</span><span style=color:#e6db74>  tagexclude = [&#34;influx_database&#34;]
</span><span style=color:#e6db74>  [outputs.influxdb.tagpass]
</span><span style=color:#e6db74>    influx_database = [&#34;system&#34;]</span>
</code></pre></div><p>This is mainly doing two things, to achieve the goal of diverting each type of metric into their own database in InfluxDB. Having them all in the same one isn&rsquo;t really a problem; it just makes it easier for me. To do this Telegraf has to add a tag to the metric it collects.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#66d9ef>[[inputs.cpu]]</span>
  <span style=color:#a6e22e>percpu</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>true
</span><span style=color:#e6db74>  totalcpu = true
</span><span style=color:#e6db74>  collect_cpu_time = false
</span><span style=color:#e6db74>  report_active = false
</span><span style=color:#e6db74>  [inputs.cpu.tags]
</span><span style=color:#e6db74>    influx_database = &#34;system&#34;</span>
</code></pre></div><p>Here I tell Telegraf to tag all the metrics from the cpu input with the tag <code>influx_database</code> set to <code>system</code>. Telegraf can use the <code>tagpass</code> and <code>tagdrop</code> to further filter the metrics. We use <code>tagpass</code> to tell Telegraf which tags this output should allow. In the example I tell it to allow all metrics tagged with <code>influx_database</code> set to system. The <code>tagdrop</code> does the opposite, it tells Telegraf which tags it should not allow. In order to keep the output somewhat clean, I tell Telegraf to not pass the <code>influx_database</code> tag to InfluxDB.</p>
<p>Other than configuring nginx to show nginx_stub status on 127.0.0.1:8080, the rest of the telegraf.conf is pretty much stock.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> 127.0.0.1:<span style=color:#ae81ff>8080</span>;
    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
        <span style=color:#f92672>stub_status</span>   <span style=color:#66d9ef>on</span>;
        <span style=color:#f92672>access_log</span>    <span style=color:#66d9ef>off</span>;
    }
}
</code></pre></div><hr>
<h1 id=setting-up-grafana>Setting up Grafana<a hidden class=anchor aria-hidden=true href=#setting-up-grafana>#</a></h1>
<p>I noticed a while back, that you can configure Grafana purely by using <a href=https://grafana.com/docs/grafana/latest/administration/configuration/#configure-with-environment-variables>enviroment variables</a>, this is awesome because it can also be set up to not use the embedded sqlite database. Which means I don&rsquo;t need to give it a volume mount for persistent data, I did however give it a mount for using the socket instead of using http between nginx and Grafana.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>  <span style=color:#f92672>grafana</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>grafana/grafana:latest</span>
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>grafana</span>
    <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>${HOSTNAME}</span>
    <span style=color:#f92672>user</span>: <span style=color:#e6db74>&#34;1000:33&#34;</span>
    <span style=color:#f92672>environment</span>:
      - <span style=color:#ae81ff>TZ=${TZ}</span>
      - <span style=color:#ae81ff>GF_AUTH_ANONYMOUS_ENABLED=true</span>
      - <span style=color:#ae81ff>GF_AUTH_ANONYMOUS_ORG_NAME=Nonsense</span>
      - <span style=color:#ae81ff>GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer</span>
      - <span style=color:#ae81ff>GF_DATABASE_URL=mysql://grafana:${GrafanaDB_PASS}@mariadb/grafana</span>
      - <span style=color:#ae81ff>GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-worldmap-panel,grafana-piechart-panel</span>
      - <span style=color:#ae81ff>GF_SECURITY_ADMIN_USER=Roxedus</span>
      - <span style=color:#ae81ff>GF_SECURITY_ALLOW_EMBEDDING=true</span>
      - <span style=color:#ae81ff>GF_SECURITY_COOKIE_SECURE=true</span>
      - <span style=color:#ae81ff>GF_SERVER_PROTOCOL=socket</span>
      - <span style=color:#ae81ff>GF_SERVER_SOCKET=/opt/socket/grafana.socket</span>
      <span style=color:#75715e># - GF_SECURITY_ADMIN_PASSWORD=${SQL_ROOT}</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>/opt/socket/:/opt/socket</span>
</code></pre></div><p>I renamed the default organization in Grafana, which means that the default anonymous(guest) access break. I fix that by declaring which organization and role the anonymous user is attached to. Then I tell Grafana how to connect to the database, and what plugins it should install on start. Since I can, I also set the admin username and password, instead of updating the user after the fact.</p>
<p>Unlike Ghost, Grafana doesnt have a way to set permissions on the socket. Therefore, Grafana runs as my user, as part of the www-data group. It is dirty, but it works.</p>
<hr>
<h1 id=reading-a-simple-logfile-with-promtail>Reading a simple logfile with Promtail<a hidden class=anchor aria-hidden=true href=#reading-a-simple-logfile-with-promtail>#</a></h1>
<p>The next part was getting Loki and Promtail set up. Oh boy what a task this was. I don&rsquo;t know why, but there isn&rsquo;t much content about this out there, if I were to guess people run the whole ELK stack. Which is way overkill for what I want to achieve here. The biggest hurdle personally was the fact that it was written in go, and therefore the config used some go-specific rules. Did you know that go&rsquo;s implementation of regex is very minimal? Or that the time-formatting is done without the notion of deliminators like YYYY-MM-DD? I for sure did not.</p>
<p>Getting the containers running was pretty simple, once you have downloaded the basic configuration files for <a href=https://github.com/grafana/loki/blob/v1.5.0/cmd/loki/loki-docker-config.yaml>Loki</a> and <a href=https://github.com/grafana/loki/blob/v1.5.0/cmd/promtail/promtail-docker-config.yaml>Promtail</a>. I choice to not use the default location inside the containers, I followed the practice of having all persistent data inn /config since I can override the <code>config.file</code> location with the command feature of docker.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>  <span style=color:#f92672>loki</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>grafana/loki:${LOKI_VER}</span>
    <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>${HOSTNAME}</span>
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>loki</span>
    <span style=color:#f92672>environment</span>:
      - <span style=color:#ae81ff>TZ=${TZ}</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>/opt/appdata/loki/config:/config:ro</span>
    <span style=color:#f92672>command</span>: -<span style=color:#ae81ff>config.file=/config/loki-config.yaml</span>

  <span style=color:#f92672>promtail</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>grafana/promtail:${LOKI_VER}</span>
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>promtail</span>
    <span style=color:#f92672>environment</span>:
      - <span style=color:#ae81ff>TZ=${TZ}</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>loki</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>/opt/appdata/promtail:/config:ro</span>
      - <span style=color:#ae81ff>/opt/logs:/opt/logs:ro</span>
      - <span style=color:#ae81ff>/var/log:/var/log:ro</span>
      - <span style=color:#ae81ff>/etc/machine-id:/etc/machine-id:ro</span>
    <span style=color:#f92672>command</span>: -<span style=color:#ae81ff>config.file=/config/promtail-config.yaml</span>
</code></pre></div><p>My Loki service is not too far off from the example Loki provides. I added the hostname for the machine and set the TZ. I will come back to the logging part later.</p>
<p>For Promtail I gave it two volume-mounts for logs, where <code>/opt/logs</code> is where the logs from the applications I run with Docker are located (not to be confused with docker logs). The next thing I did was to change the <code>promtail-config.yaml</code> file to tell Promtail to read the logs in <code>/opt</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>server</span>:
  <span style=color:#f92672>http_listen_port</span>: <span style=color:#ae81ff>9080</span>
  <span style=color:#f92672>grpc_listen_port</span>: <span style=color:#ae81ff>0</span>

<span style=color:#f92672>positions</span>:
  <span style=color:#f92672>filename</span>: <span style=color:#ae81ff>/tmp/positions.yaml</span>

<span style=color:#f92672>clients</span>:
  - <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://loki:3100/loki/api/v1/push</span>

<span style=color:#f92672>scrape_configs</span>:
  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>system</span>
    <span style=color:#f92672>pipeline_stages</span>:


    <span style=color:#f92672>static_configs</span>:
      - <span style=color:#f92672>targets</span>:
          - <span style=color:#ae81ff>localhost</span>
        <span style=color:#f92672>labels</span>:
          <span style=color:#f92672>job</span>: <span style=color:#ae81ff>varlogs</span>
          <span style=color:#f92672>__path__</span>: <span style=color:#ae81ff>/var/log/**/**log</span>
      - <span style=color:#f92672>targets</span>:
          - <span style=color:#ae81ff>localhost</span>
        <span style=color:#f92672>labels</span>:
          <span style=color:#f92672>job</span>: <span style=color:#ae81ff>containers</span>
          <span style=color:#f92672>__path__</span>: <span style=color:#ae81ff>/opt/logs/**/*log</span>
</code></pre></div><p>I could have added the <code>__path__</code> to the varlogs job, but I added it as a new job to be able to filter it out easily in Grafana. They would present themselves something like this:</p>
<p><img loading=lazy src=images/explorer.gif alt>
</p>
<p>As well as labeling the data with the job-name, it also labels it with the filename, which is neat when you want to focus on a specific logfile. If you look closely you can see that Loki didn&rsquo;t read the timestamp properly. This is something we can fix manually and depending on the original time-format its not that difficult, after getting over the hurdles that is go&rsquo;s time-formatting. The documentation does cover it, but it takes a few clicks to get there, so here is a <a href=https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/timestamp.md>link</a>. <del>There is a catch here though, especially if you know language like python. go&rsquo;s time-formater doesn&rsquo;t handle milliseconds with commas, there is an <a href=https://github.com/golang/go/issues/6189>issue</a> open about this from 2013.</del></p>
<blockquote>
<p>2021 Note: Looks like this is no longer the case</p>
</blockquote>
<p>You can still get the timestamp, but there is an additional step that need to be taken for that. I ran into that issue with the fail2ban logs, and I will walk you trough how I solved it. Here is a line from that log.</p>
<pre><code>2020-05-27 21:51:50,138 fail2ban.filter         [9474]: INFO    [sshd] Found 1.1.1.1 - 2020-05-27 21:51:50
</code></pre><p>The first thing that had to be done was extracting the timestamp from the line. This is done with a <a href=https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/regex.md>regex stage</a>. Note the that the backslashes needs to be escaped.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>regex</span>:
  <span style=color:#f92672>expression</span>:
    <span style=color:#e6db74>&#34;(?P&lt;time&gt;\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2},\\d{0,3})
</span><span style=color:#e6db74>    (?P&lt;message&gt;fail2ban.*(?P&lt;pid&gt;\\[\\d*\\]: )(?P&lt;level&gt;[A-Z]{4,7}) .*)&#34;</span>
</code></pre></div><p>I am also going to be extracting a few other things, like the message itself, the PID and the log-level, to use in other stages. You can look at the regex in action on <a href=https://regex101.com/r/qNaeoG/>regex101.com</a>.</p>
<p>Now I can use the content of <code>time</code> group as a variable in Promtail. The next step is to replace the comma with a dot, so Promtail can understand the time-format. This is done with a <a href=https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/template.md>template step</a>. That is another thing worth looking into, go&rsquo;s template system. After reading about the replace function on the string function, it was pretty clear that it was the last piece of the puzzle I needed to solve before putting it all together.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>template</span>:
  <span style=color:#f92672>source</span>: <span style=color:#ae81ff>time</span>
  <span style=color:#f92672>template</span>: <span style=color:#e6db74>&#39;{{ Replace .Value &#34;,&#34; &#34;.&#34; -1 }}&#39;</span>
</code></pre></div><p>Now we have the time variable available, because all the capture groups created with the regex step is exported for us to use. I pass it to the template. .Value is the value from the variable set as source. Then it replaces , with . for -1 times, -1 is the same as replace all. The output of this step is a new time variable, same name, new content. We can now define the <a href=https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/timestamp.md>timestamp</a> in the next stage.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>timestamp</span>:
  <span style=color:#f92672>source</span>: <span style=color:#ae81ff>time</span>
  <span style=color:#f92672>format</span>: <span style=color:#e6db74>&#34;2006-01-02 15:04:05.000&#34;</span>
</code></pre></div><p>This is how you define a time-format in GO. This is it. It is a clever way to do it, it uses a set value for each component. The year it looks for is 2006, so it&rsquo;s either <code>06</code> or <code>2006</code>. The month has a few more options <code>1</code>, <code>01</code>, <code>Jan</code> or <code>January</code>. So, in a sense it is all pretty easy to read. All the possibilities for the components are in the documentation for the timestamp stage.</p>
<p>Now Promtail know what time the log was sent for.</p>
<p>I am not happy with the result; it has data I don&rsquo;t need, there is more I can do. If you look at the initial line from the log, it also has the time at the end, neither do I need the PID. I can fix this with another template step and a regex step.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>template</span>:
  <span style=color:#f92672>source</span>: <span style=color:#ae81ff>message</span>
  <span style=color:#f92672>template</span>: <span style=color:#e6db74>&#39;{{ Replace .Value .pid &#34;&#34; -1 }}&#39;</span>
</code></pre></div><p>In this stage it reads the message extracted from the initial regex, then it replaces the content of the capture-group/label called <code>pid</code> with nothing.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>regex</span>:
  <span style=color:#f92672>expression: &#39;(?P&lt;message&gt;.*)(?</span>: - <span style=color:#ae81ff>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})&#39;</span>
  <span style=color:#f92672>source</span>: <span style=color:#ae81ff>message</span>
</code></pre></div><p>This regex step uses the message passed from the previous template step and creates a new message capture-group, the important thing here is that it places the eventual timestamp in its own capture group, which is not a part of the message group.</p>
<p>If I were to start Promtail now, it would still see the line as it is in the log. Promtail needs to be told what it should be passing along, so we use the <a href=https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/output.md>output stage</a>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>output</span>:
   <span style=color:#f92672>source</span>: <span style=color:#ae81ff>message</span>
</code></pre></div><p>However it also needs to be told what to apply all these steps to, so a final configuration to get Promtail to read and parse the Fail2Ban log would look something like this.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>server</span>:
  <span style=color:#f92672>http_listen_port</span>: <span style=color:#ae81ff>9080</span>
  <span style=color:#f92672>grpc_listen_port</span>: <span style=color:#ae81ff>0</span>

<span style=color:#f92672>positions</span>:
  <span style=color:#f92672>filename</span>: <span style=color:#ae81ff>/tmp/positions.yaml</span>

<span style=color:#f92672>clients</span>:
  - <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://loki:3100/loki/api/v1/push</span>

<span style=color:#f92672>scrape_configs</span>:
  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>system</span>
    <span style=color:#f92672>pipeline_stages</span>:
      - <span style=color:#f92672>match</span>:
          <span style=color:#f92672>selector</span>: <span style=color:#e6db74>&#39;{filename=~&#34;.*fail2ban.log&#34;}&#39;</span>
          <span style=color:#f92672>stages</span>:
            - <span style=color:#f92672>regex</span>:
                <span style=color:#f92672>expression</span>:
                  <span style=color:#e6db74>&#34;(?P&lt;time&gt;\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2},\\d{0,3})?\\D?
</span><span style=color:#e6db74>                  (?P&lt;message&gt;fail2ban.*(?P&lt;pid&gt;\\[\\d*\\]: )(?P&lt;level&gt;[A-Z]{4,7}) .*
</span><span style=color:#e6db74>                  (?:(?:\\[|Jail &#39;)(?P&lt;jail&gt;\\D*)(?:\\]|&#39;))?.*)&#34;</span>
            - <span style=color:#f92672>template</span>:
                <span style=color:#f92672>source</span>: <span style=color:#ae81ff>message</span>
                <span style=color:#f92672>template</span>: <span style=color:#e6db74>&#39;{{ Replace .Value .pid &#34;&#34; -1 }}&#39;</span>
            - <span style=color:#f92672>regex</span>:
                <span style=color:#f92672>expression: &#39;(?P&lt;message&gt;.*)(?</span>: - <span style=color:#ae81ff>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})&#39;</span>
                <span style=color:#f92672>source</span>: <span style=color:#ae81ff>message</span>
            - <span style=color:#f92672>template</span>:
                <span style=color:#f92672>source</span>: <span style=color:#ae81ff>time</span>
                <span style=color:#f92672>template</span>: <span style=color:#e6db74>&#39;{{ Replace .Value &#34;,&#34; &#34;.&#34; -1 }}&#39;</span>
            - <span style=color:#f92672>timestamp</span>:
                <span style=color:#f92672>source</span>: <span style=color:#ae81ff>time</span>
                <span style=color:#f92672>format</span>: <span style=color:#e6db74>&#34;2006-01-02 15:04:05.000&#34;</span>
            - <span style=color:#f92672>output</span>:
                <span style=color:#f92672>source</span>: <span style=color:#ae81ff>message</span>


    <span style=color:#f92672>static_configs</span>:
      - <span style=color:#f92672>targets</span>:
          - <span style=color:#ae81ff>localhost</span>
        <span style=color:#f92672>labels</span>:
          <span style=color:#f92672>job</span>: <span style=color:#ae81ff>varlogs</span>
          <span style=color:#f92672>__path__</span>: <span style=color:#ae81ff>/var/log/**/**log</span>
      - <span style=color:#f92672>targets</span>:
          - <span style=color:#ae81ff>localhost</span>
        <span style=color:#f92672>labels</span>:
          <span style=color:#f92672>job</span>: <span style=color:#ae81ff>containers</span>
          <span style=color:#f92672>__path__</span>: <span style=color:#ae81ff>/opt/logs/**/*log</span>
</code></pre></div><p>In order for Promtail to know where to apply these stages, it needs to match it to something. Grafana is then again presenting a new concept with Loki, <a href=https://github.com/grafana/loki/blob/master/docs/logql.md>LogQL</a>. It is an adaptation of Prometheus' query language, focused on logs. This is used in the selector, I kept mine simple. It is only matching against filenames ending with fail2ban.log, the filename includes paths, which is why there is a wildcard in front.</p>
<hr>
<h1 id=reading-docker-logs-with-promtail>Reading docker-logs with Promtail<a hidden class=anchor aria-hidden=true href=#reading-docker-logs-with-promtail>#</a></h1>
<p>Loki has a docker log-driver, which as the time of writing has a few deal breaking issues, mainly <a href=https://github.com/grafana/loki/issues/2017>#2017</a>. To work around this, I found that sending docker-logs to the journal works for my use case. The Promtail config for this was surprisingly easy, by just setting up the journal job example from Promtails documentation.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>server</span>:
  <span style=color:#f92672>http_listen_port</span>: <span style=color:#ae81ff>9080</span>
  <span style=color:#f92672>grpc_listen_port</span>: <span style=color:#ae81ff>0</span>

<span style=color:#f92672>positions</span>:
  <span style=color:#f92672>filename</span>: <span style=color:#ae81ff>/tmp/positions.yaml</span>

<span style=color:#f92672>clients</span>:
  - <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://loki:3100/loki/api/v1/push</span>

<span style=color:#f92672>scrape_configs</span>:
  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>system</span>
    <span style=color:#f92672>pipeline_stages</span>:
  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>journal</span>
    <span style=color:#f92672>journal</span>:
      <span style=color:#f92672>max_age</span>: <span style=color:#ae81ff>12h</span>
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>job</span>: <span style=color:#ae81ff>systemd-journal</span>
    <span style=color:#f92672>relabel_configs</span>:
      - <span style=color:#f92672>source_labels</span>: [<span style=color:#e6db74>&#34;__journal__systemd_unit&#34;</span>]
        <span style=color:#f92672>target_label</span>: <span style=color:#e6db74>&#34;unit&#34;</span>
</code></pre></div><p>That will give us the journal from the host since /var/log/journal is mapped.</p>
<p>There is a few ways to tell docker to <a href=https://docs.docker.com/config/containers/logging/journald/>log to the journal</a>, however I am going to do it in my docker-compose. I simply just add a few lines to the containers I want to see in Grafana.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>    <span style=color:#f92672>logging</span>:
      <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>journald</span>
      <span style=color:#f92672>options</span>:
        <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>non-blocking</span>
</code></pre></div><p>My Matomo instance would then look something like this.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>  <span style=color:#f92672>matomo</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>matomo:fpm-alpine</span>
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>matomo</span>
    <span style=color:#f92672>logging</span>:
      <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>journald</span>
      <span style=color:#f92672>options</span>:
        <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>non-blocking</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>mariadb</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>/opt/appdata/matomo:/var/www/html</span>
      - <span style=color:#ae81ff>/opt/logs/matomo:/logz</span>
</code></pre></div><p>Now I can see the logs from the Matomo container in Grafana, however it does not have a label I can use to sort out all the entries which does not come from the container. I can do that by adding a relabel action in the job-definition. Promtail presents all metadata from the journal with the <code>__journal_</code> label-prefix. This means that we can access the <code>CONTAINER_NAME</code> attribute docker adds to the logfile with the label <code>__journal_container_name</code>, so by adding a <a href=https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/configuration.md#relabel_config>relabel_config</a> we can get the container name as a label in Promtail.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>server</span>:
  <span style=color:#f92672>http_listen_port</span>: <span style=color:#ae81ff>9080</span>
  <span style=color:#f92672>grpc_listen_port</span>: <span style=color:#ae81ff>0</span>

<span style=color:#f92672>positions</span>:
  <span style=color:#f92672>filename</span>: <span style=color:#ae81ff>/tmp/positions.yaml</span>

<span style=color:#f92672>clients</span>:
  - <span style=color:#f92672>url</span>: <span style=color:#ae81ff>http://loki:3100/loki/api/v1/push</span>

<span style=color:#f92672>scrape_configs</span>:
  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>system</span>
    <span style=color:#f92672>pipeline_stages</span>:
  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>journal</span>
    <span style=color:#f92672>journal</span>:
      <span style=color:#f92672>max_age</span>: <span style=color:#ae81ff>12h</span>
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>job</span>: <span style=color:#ae81ff>systemd-journal</span>
    <span style=color:#f92672>relabel_configs</span>:
      - <span style=color:#f92672>source_labels</span>: [<span style=color:#e6db74>&#34;__journal__systemd_unit&#34;</span>]
        <span style=color:#f92672>target_label</span>: <span style=color:#e6db74>&#34;unit&#34;</span>
      - <span style=color:#f92672>source_labels</span>: [<span style=color:#e6db74>&#34;__journal_container_name&#34;</span>]
        <span style=color:#f92672>target_label</span>: <span style=color:#e6db74>&#34;container&#34;</span>
</code></pre></div><p>It will present the logs similar to this:</p>
<p><img loading=lazy src=images/explorer-journald.gif alt>
</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://nonsense.fyi/tags/automation/>Automation</a></li>
</ul>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Deploying Loki and Promtail Together With the TIG Stack on twitter" href="https://twitter.com/intent/tweet/?text=Deploying%20Loki%20and%20Promtail%20Together%20With%20the%20TIG%20Stack&url=https%3a%2f%2fnonsense.fyi%2fposts%2fdeploying-loki-and-promtail-together-with-the-tig-stack%2f&hashtags=Automation"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Deploying Loki and Promtail Together With the TIG Stack on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnonsense.fyi%2fposts%2fdeploying-loki-and-promtail-together-with-the-tig-stack%2f&title=Deploying%20Loki%20and%20Promtail%20Together%20With%20the%20TIG%20Stack&summary=Deploying%20Loki%20and%20Promtail%20Together%20With%20the%20TIG%20Stack&source=https%3a%2f%2fnonsense.fyi%2fposts%2fdeploying-loki-and-promtail-together-with-the-tig-stack%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Deploying Loki and Promtail Together With the TIG Stack on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnonsense.fyi%2fposts%2fdeploying-loki-and-promtail-together-with-the-tig-stack%2f&title=Deploying%20Loki%20and%20Promtail%20Together%20With%20the%20TIG%20Stack"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Deploying Loki and Promtail Together With the TIG Stack on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnonsense.fyi%2fposts%2fdeploying-loki-and-promtail-together-with-the-tig-stack%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Deploying Loki and Promtail Together With the TIG Stack on whatsapp" href="https://api.whatsapp.com/send?text=Deploying%20Loki%20and%20Promtail%20Together%20With%20the%20TIG%20Stack%20-%20https%3a%2f%2fnonsense.fyi%2fposts%2fdeploying-loki-and-promtail-together-with-the-tig-stack%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Deploying Loki and Promtail Together With the TIG Stack on telegram" href="https://telegram.me/share/url?text=Deploying%20Loki%20and%20Promtail%20Together%20With%20the%20TIG%20Stack&url=https%3a%2f%2fnonsense.fyi%2fposts%2fdeploying-loki-and-promtail-together-with-the-tig-stack%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer><script src=https://giscus.app/client.js data-repo=Roxedus/nonsense.fyi data-repo-id="MDEwOlJlcG9zaXRvcnkyNTkxMzY1NDE=" data-category=Announcements data-category-id=DIC_kwDOD3IcHc4B-8g4 data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=preferred_color_scheme crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://nonsense.fyi/>nonsense.fyi</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>